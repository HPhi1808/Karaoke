<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-gray-800 fw-bold"><i class="bi bi-bell"></i> Qu·∫£n L√Ω Th√¥ng B√°o H·ªá Th·ªëng</h4>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createNotificationModal">
            <i class="bi bi-plus-lg"></i> T·∫°o th√¥ng b√°o m·ªõi
        </button>
    </div>

    <div class="row">
        <div class="col-lg-12 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-list-ul"></i> Danh s√°ch th√¥ng b√°o ƒë√£ g·ª≠i
                    </h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.fetchNotifications()">
                        <i class="bi bi-arrow-clockwise"></i> T·∫£i l·∫°i
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Ti√™u ƒë·ªÅ</th>
                                    <th>N·ªôi dung</th>
                                    <th>Ng√†y t·∫°o</th>
                                    <th class="text-center">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="notificationTableBody">
                                <tr><td colspan="4" class="text-center py-3">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createNotificationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">G·ª≠i th√¥ng b√°o m·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createNotifForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">ƒê·ªëi t∆∞·ª£ng nh·∫≠n <span class="text-danger">*</span></label>
                        <select class="form-select" id="newTarget">
                            <option value="all">üì¢ T·∫•t c·∫£ m·ªçi ng∆∞·ªùi (Bao g·ªìm kh√°ch)</option>
                            <option value="user">üë§ Ch·ªâ th√†nh vi√™n ƒëƒÉng k√Ω</option>
                        </select>
                        <small class="text-muted">"T·∫•t c·∫£" d√πng cho th√¥ng b√°o b·∫£o tr√¨. "Th√†nh vi√™n" d√πng cho s·ª± ki·ªán/khuy·∫øn m√£i.</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ti√™u ƒë·ªÅ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newTitle" required placeholder="V√≠ d·ª•: B·∫£o tr√¨ h·ªá th·ªëng">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">N·ªôi dung <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="newMessage" rows="4" required placeholder="Nh·∫≠p n·ªôi dung..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="window.submitNotification()">
                    <i class="bi bi-send"></i> G·ª≠i & ƒê·∫©y th√¥ng b√°o
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editNotificationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-warning">Ch·ªânh s·ª≠a n·ªôi dung (Database)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger small">L∆∞u √Ω: Vi·ªác s·ª≠a ·ªü ƒë√¢y ch·ªâ c·∫≠p nh·∫≠t trong app, kh√¥ng thay ƒë·ªïi th√¥ng b√°o ƒë·∫©y ƒë√£ g·ª≠i ƒëi.</p>
                <form id="editNotifForm">
                    <input type="hidden" id="editNotifId">
                    <div class="mb-3">
                        <label class="form-label">Ti√™u ƒë·ªÅ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">N·ªôi dung <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editMessage" rows="4" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-warning" onclick="window.updateNotification()">
                    <i class="bi bi-save"></i> L∆∞u thay ƒë·ªïi
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    {
        let currentNotificationsList = [];
        const tbody = document.getElementById('notificationTableBody');

        // --- H√ÄM H·ªñ TR·ª¢: T·∫†O HTML CHO 1 H√ÄNG ---
        function generateRowHtml(item) {
            return `
                <tr id="notif-row-${item.id}">
                    <td class="ps-4 fw-bold notif-title">${item.title}</td>
                    <td class="notif-message">${item.message}</td>
                    <td class="small text-muted">${new Date(item.created_at).toLocaleString('vi-VN')}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-warning me-1" onclick="window.openEditModal('${item.id}')" title="S·ª≠a">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="window.deleteNotification('${item.id}')" title="X√≥a">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        // --- H√ÄM H·ªñ TR·ª¢: KI·ªÇM TRA B·∫¢NG TR·ªêNG ---
        function checkEmptyTable() {
            if (tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted" id="no-data-row">Ch∆∞a c√≥ th√¥ng b√°o n√†o.</td></tr>';
            }
        }

        // --- 1. L·∫§Y DANH S√ÅCH ---
        window.fetchNotifications = async function () {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> ƒêang t·∫£i...</td></tr>';

            const res = await window.api('/api/admin/notifications');

            if (res && res.status === 'success') {
                const notifications = res.data || [];
                currentNotificationsList = notifications;

                if (notifications.length === 0) {
                    checkEmptyTable();
                    return;
                }

                tbody.innerHTML = notifications.map(item => generateRowHtml(item)).join('');
            } else {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">L·ªói: ${res?.message || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu'}</td></tr>`;
            }
        }

        // --- 2. G·ª¨I M·ªöI (CREATE) - UPDATE DOM TR·ª∞C TI·∫æP ---
        window.submitNotification = async function () {
            const title = document.getElementById('newTitle').value.trim();
            const message = document.getElementById('newMessage').value.trim();
            const target = document.getElementById('newTarget').value;

            if (!title || !message) return alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');

            const btn = document.querySelector('#createNotificationModal .btn-primary');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang g·ª≠i...';

            const res = await window.api('/api/admin/notifications', {
                method: 'POST',
                body: JSON.stringify({ title, message, target })
            });

            btn.disabled = false;
            btn.innerHTML = originalText;

            if (res && res.status === 'success') {
                alert(`ƒê√£ g·ª≠i th√¥ng b√°o th√†nh c√¥ng t·ªõi nh√≥m: ${target === 'all' ? 'T·∫•t c·∫£' : 'Th√†nh vi√™n'}`);
                
                const newItem = res.data;
                
                if (newItem) {
                    const noDataRow = document.getElementById('no-data-row');
                    if (noDataRow) noDataRow.parentElement.remove();
                    if (tbody.innerHTML.includes('L·ªói:') || tbody.innerHTML.includes('ƒêang t·∫£i')) tbody.innerHTML = '';

                    const newRowHtml = generateRowHtml(newItem);
                    tbody.insertAdjacentHTML('afterbegin', newRowHtml);
                    
                    currentNotificationsList.unshift(newItem);
                } else {
                    window.fetchNotifications();
                }

                document.getElementById('createNotifForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('createNotificationModal')).hide();
            } else {
                alert('L·ªói: ' + (res?.message));
            }
        }

        // --- 3. M·ªû MODAL S·ª¨A ---
        window.openEditModal = function(id) {
            const notif = currentNotificationsList.find(item => item.id == id);
            
            if (!notif) {
                const row = document.getElementById(`notif-row-${id}`);
                if(!row) return alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu!");
                document.getElementById('editNotifId').value = id;
                document.getElementById('editTitle').value = row.querySelector('.notif-title').innerText;
                document.getElementById('editMessage').value = row.querySelector('.notif-message').innerText;
            } else {
                document.getElementById('editNotifId').value = notif.id;
                document.getElementById('editTitle').value = notif.title;
                document.getElementById('editMessage').value = notif.message;
            }

            const editModal = new bootstrap.Modal(document.getElementById('editNotificationModal'));
            editModal.show();
        }

        // --- 4. L∆ØU C·∫¨P NH·∫¨T (UPDATE) - UPDATE DOM TR·ª∞C TI·∫æP ---
        window.updateNotification = async function() {
            const id = document.getElementById('editNotifId').value;
            const title = document.getElementById('editTitle').value.trim();
            const message = document.getElementById('editMessage').value.trim();

            if (!title || !message) return alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');

            const res = await window.api(`/api/admin/notifications/${id}`, {
                method: 'PUT',
                body: JSON.stringify({ title, message })
            });

            if (res && res.status === 'success') {
                alert('C·∫≠p nh·∫≠t n·ªôi dung th√†nh c√¥ng!');
                
                const row = document.getElementById(`notif-row-${id}`);
                if (row) {
                    row.querySelector('.notif-title').innerText = title;
                    row.querySelector('.notif-message').innerText = message;
                    
                    row.classList.add('table-warning');
                    setTimeout(() => row.classList.remove('table-warning'), 1000);
                }

                const index = currentNotificationsList.findIndex(x => x.id == id);
                if (index !== -1) {
                    currentNotificationsList[index].title = title;
                    currentNotificationsList[index].message = message;
                }

                bootstrap.Modal.getInstance(document.getElementById('editNotificationModal')).hide();
            } else {
                alert('L·ªói: ' + (res?.message || 'Kh√¥ng c·∫≠p nh·∫≠t ƒë∆∞·ª£c'));
            }
        }

        // --- 5. X√ìA (DELETE) - UPDATE DOM TR·ª∞C TI·∫æP ---
        window.deleteNotification = async function (id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th√¥ng b√°o n√†y kh√¥ng?')) return;
            
            const res = await window.api(`/api/admin/notifications/${id}`, { method: 'DELETE' });

            if (res && res.status === 'success') {
                const row = document.getElementById(`notif-row-${id}`);
                if (row) {
                    row.remove();
                }

                currentNotificationsList = currentNotificationsList.filter(item => item.id != id);

                checkEmptyTable();
            } else {
                alert('L·ªói: ' + (res?.message));
            }
        }

        window.fetchNotifications();
    }
</script>