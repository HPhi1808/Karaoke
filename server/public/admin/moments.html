<style>
    .avatar-small {
        width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #dee2e6;
    }
    .audio-player-sm {
        height: 40px;           /* Cao h∆°n x√≠u cho d·ªÖ b·∫•m */
        width: 100%;            /* D√£n h·∫øt c·ª° chi·ªÅu ngang cho ph√©p */
        min-width: 350px;       /* B·∫ÆT BU·ªòC d√†i √≠t nh·∫•t 350px (ƒë·ªÉ thanh tua d√†i ra) */
        border-radius: 20px;
        margin-top: 5px;
        outline: none;
    }

    .moment-desc {
        max-width: 400px;       /* Cho ph√©p m√¥ t·∫£ d√†i h∆°n */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .stat-box {
        font-size: 0.85rem;
        display: inline-block;
        padding: 4px 8px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        margin-right: 4px;
    }
</style>

<div class="card shadow border-0 mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h5 class="m-0 font-weight-bold text-primary"><i class="bi bi-music-note-list"></i> Qu·∫£n l√Ω B√†i ƒëƒÉng (Moments)</h5>
        <button class="btn btn-outline-primary btn-sm" onclick="fetchMoments()"><i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi</button>
    </div>
    
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3">Ng∆∞·ªùi ƒëƒÉng</th>
                        <th>N·ªôi dung & Audio</th>
                        <th>T∆∞∆°ng t√°c</th>
                        <th>Th·ªùi gian</th>
                        <th class="text-center">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="momentsBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="commentsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">B√¨nh lu·∫≠n c·ªßa b√†i vi·∫øt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped mb-0">
                        <tbody id="commentsListBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
{
    const MOMENT_API = '/api/admin/moments';
    let realtimeChannel = null;
    let currentOpenMomentId = null;

    // --- 1. L·∫§Y D·ªÆ LI·ªÜU MOMENTS ---
    window.fetchMoments = async function(isBackground = false) {
        const tbody = document.getElementById('momentsBody');
        
        if (!isBackground) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';
        }

        try {
            const res = await window.api(MOMENT_API);
            if (!res) return;
            const moments = Array.isArray(res) ? res : [];

            if (moments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o.</td></tr>';
                return;
            }

            tbody.innerHTML = moments.map(m => {
                const avatar = m.avatar_url || 'https://placehold.co/40?text=U';
                const name = m.full_name || '·∫®n danh';
                const email = m.email || 'No Email';
                const time = new Date(m.created_at).toLocaleString('vi-VN');
                const desc = m.description || '<span class="text-muted fst-italic">Kh√¥ng c√≥ m√¥ t·∫£</span>';

                return `
                    <tr id="moment-${m.moment_id}">
                        <td class="ps-3">
                            <div class="d-flex align-items-center gap-2">
                                <img src="${avatar}" class="avatar-small" onerror="this.src='https://placehold.co/40'">
                                <div>
                                    <div class="fw-bold text-dark" style="font-size:0.9rem;">${name}</div>
                                    <div class="text-muted small">${email}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="moment-desc fw-bold mb-1" title="${m.description}">${desc}</div>
                            <audio controls src="${m.audio_url}" class="audio-player-sm" preload="none"></audio>
                        </td>
                        <td>
                            <div class="d-flex">
                                <div class="stat-box text-danger" title="L∆∞·ª£t th√≠ch"><i class="bi bi-heart-fill"></i> ${m.like_count}</div>
                                <div class="stat-box text-primary pointer" title="B√¨nh lu·∫≠n" onclick="viewComments(${m.moment_id})">
                                    <i class="bi bi-chat-dots-fill"></i> ${m.comment_count}
                                </div>
                                <div class="stat-box text-secondary" title="L∆∞·ª£t xem"><i class="bi bi-eye-fill"></i> ${m.view_count || 0}</div>
                            </div>
                        </td>
                        <td class="text-muted small">${time}</td>
                        <td class="text-center">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewComments(${m.moment_id})" title="Xem b√¨nh lu·∫≠n">
                                    <i class="bi bi-chat-text"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMoment(${m.moment_id})" title="X√≥a b√†i ƒëƒÉng">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

        } catch (e) {
            console.error(e);
            if (!isBackground) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">L·ªói t·∫£i d·ªØ li·ªáu: ${e.message}</td></tr>`;
            }
        }
    }

    // --- 2. X√ìA MOMENT ---
    window.deleteMoment = async function(id) {
        if(!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i ƒëƒÉng n√†y kh√¥ng? H√†nh ƒë·ªông n√†y s·∫Ω x√≥a c·∫£ file audio tr√™n Cloud.')) return;
        
        try {
            const res = await window.api(`${MOMENT_API}/${id}`, { method: 'DELETE' });
            if (res && res.status === 'success') {
                // Kh√¥ng c·∫ßn x√≥a DOM th·ªß c√¥ng n·ªØa v√¨ Realtime s·∫Ω t·ª± g·ªçi fetchMoments
                // Tuy nhi√™n x√≥a th·ªß c√¥ng gi√∫p UX m∆∞·ª£t h∆°n (ph·∫£n h·ªìi t·ª©c th√¨)
                const row = document.getElementById(`moment-${id}`);
                if(row) row.remove();
                alert('ƒê√£ x√≥a th√†nh c√¥ng!');
            } else {
                alert('L·ªói: ' + (res?.message || 'Unknown'));
            }
        } catch (e) {
            alert('L·ªói k·∫øt n·ªëi: ' + e.message);
        }
    }

    // --- 3. XEM V√Ä QU·∫¢N L√ù COMMENT (MODAL) ---
    window.viewComments = async function(momentId) {
        currentOpenMomentId = momentId; // L∆∞u l·∫°i ID ƒëang xem
        const tbody = document.getElementById('commentsListBody');
        tbody.innerHTML = '<tr><td class="text-center p-3"><div class="spinner-border spinner-border-sm text-primary"></div> ƒêang t·∫£i b√¨nh lu·∫≠n...</td></tr>';
        
        // L·∫Øng nghe s·ª± ki·ªán ƒë√≥ng modal ƒë·ªÉ reset bi·∫øn
        const modalEl = document.getElementById('commentsModal');
        modalEl.addEventListener('hidden.bs.modal', function () {
            currentOpenMomentId = null;
        });

        new bootstrap.Modal(modalEl).show();

        await loadCommentsForModal(momentId);
    }

    // T√°ch h√†m load comment ri√™ng ƒë·ªÉ t√°i s·ª≠ d·ª•ng khi Realtime trigger
    async function loadCommentsForModal(momentId) {
        const tbody = document.getElementById('commentsListBody');
        if (!currentOpenMomentId || currentOpenMomentId != momentId) return;

        try {
            const res = await window.api(`${MOMENT_API}/${momentId}/comments`);
            const comments = Array.isArray(res) ? res : [];

            if (comments.length === 0) {
                tbody.innerHTML = '<tr><td class="text-center p-4 text-muted">B√†i vi·∫øt n√†y ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</td></tr>';
                return;
            }

            tbody.innerHTML = comments.map(c => {
                const avatar = c.avatar_url || 'https://placehold.co/30';
                const time = new Date(c.created_at).toLocaleString('vi-VN');
                
                return `
                    <tr id="cmt-${c.id}">
                        <td style="width: 50px;">
                            <img src="${avatar}" class="rounded-circle" style="width:35px;height:35px;object-fit:cover;" onerror="this.src='https://placehold.co/30'">
                        </td>
                        <td>
                            <div class="fw-bold" style="font-size:0.85rem;">${c.full_name || c.email}</div>
                            <div class="text-dark bg-light p-2 rounded d-inline-block mt-1 border" style="max-width: 100%;">${c.content}</div>
                            <div class="text-muted small mt-1">${time}</div>
                        </td>
                        <td class="text-end align-middle">
                            <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteComment(${c.id})" title="X√≥a b√¨nh lu·∫≠n n√†y">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

        } catch (e) {
            tbody.innerHTML = `<tr><td class="text-center text-danger">L·ªói: ${e.message}</td></tr>`;
        }
    }

    // --- 4. X√ìA COMMENT ---
    window.deleteComment = async function(commentId) {
        if(!confirm('X√≥a b√¨nh lu·∫≠n n√†y?')) return;
        try {
            const res = await window.api(`${MOMENT_API}/comments/${commentId}`, { method: 'DELETE' });
            if (res && res.status === 'success') {
                // X√≥a UI ngay l·∫≠p t·ª©c
                const row = document.getElementById(`cmt-${commentId}`);
                if(row) row.remove();
                // fetchMoments s·∫Ω t·ª± ƒë∆∞·ª£c g·ªçi b·ªüi Realtime ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë ƒë·∫øm b√™n ngo√†i
            } else {
                alert('L·ªói: ' + (res?.message || 'Unknown'));
            }
        } catch (e) {
            alert('L·ªói: ' + e.message);
        }
    }

    // --- 5. REALTIME (QUAN TR·ªåNG) ---
    async function initRealtimeMoments() {
        if (!sbClient) return;

        const token = localStorage.getItem('access_token');
        const refreshToken = localStorage.getItem('refresh_token');

        if (token) {
            await sbClient.auth.setSession({ access_token: token, refresh_token: refreshToken });
        }

        if (realtimeChannel) sbClient.removeChannel(realtimeChannel);

        // ƒêƒÉng k√Ω l·∫Øng nghe thay ƒë·ªïi tr√™n 3 b·∫£ng
        realtimeChannel = sbClient.channel('admin-moments-changes')
            // 1. B·∫£ng MOMENTS (Th√™m b√†i, S·ª≠a b√†i, X√≥a b√†i)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'moments' }, () => {
                console.log('üîî Moments changed');
                fetchMoments(true); // Load l·∫°i danh s√°ch ngo√†i (background)
            })
            // 2. B·∫£ng COMMENT (Th√™m/X√≥a comment)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'moment_comments' }, (payload) => {
                console.log('üîî Comments changed');
                fetchMoments(true); // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng comment ·ªü danh s√°ch ngo√†i
                
                // N·∫øu ƒëang m·ªü modal c·ªßa ƒë√∫ng b√†i ƒëƒÉng c√≥ comment thay ƒë·ªïi -> Reload modal
                if (currentOpenMomentId && payload.new.moment_id == currentOpenMomentId || payload.old.moment_id == currentOpenMomentId) {
                    loadCommentsForModal(currentOpenMomentId);
                }
            })
            // 3. B·∫£ng LIKE (Th√™m/X√≥a like)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'moment_likes' }, () => {
                console.log('üîî Likes changed');
                fetchMoments(true); // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng tim
            })
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') console.log("‚úÖ Realtime Moments Connected!");
            });
    }

    // Init
    fetchMoments();
    initRealtimeMoments();
}
</script>