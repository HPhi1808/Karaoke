<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-gray-800 fw-bold"><i class="bi bi-speedometer2"></i> Tổng Quan Hệ Thống</h4>
        <div>
            <span class="text-muted small me-2">Cập nhật realtime: <span
                    class="badge bg-success pulse-animation">Bật</span></span>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-xl-4 col-md-6">
            <div class="card shadow border-0 h-100 py-2" style="border-left: 4px solid #1cc88a !important;">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Đang hoạt động (Live)</div>
                            <div class="h3 mb-0 font-weight-bold text-gray-800 d-flex align-items-center" style="height: 1.2em; overflow: hidden;" id="statOnline">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-broadcast text-success fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-md-6">
            <div class="card shadow border-0 h-100 py-2" style="border-left: 4px solid #4e73df !important;">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Tổng Người Dùng</div>
                            <div class="h3 mb-0 font-weight-bold text-gray-800" id="statUsers">...</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-people-fill text-primary fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-md-6">
            <div class="card shadow border-0 h-100 py-2" style="border-left: 4px solid #36b9cc !important;">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Tài khoản Khách</div>
                            <div class="h3 mb-0 font-weight-bold text-gray-800" id="statGuests">...</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-person-badge text-info fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* --- CSS CHO HIỆU ỨNG ODOMETER (LẬT SỐ) --- */
    .digit-container {
        display: inline-block;
        overflow: hidden;
        height: 1.2em;
        line-height: 1.2em;
        position: relative;
    }

    .digit-strip {
        display: flex;
        flex-direction: column;
        transition: transform 0.8s cubic-bezier(0.1, 0.7, 0.1, 1);
        will-change: transform;
    }

    .digit-strip span {
        height: 1.2em;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<script>
    {
        // Biến lưu interval để clear khi chuyển trang
        let onlineInterval;

        // --- 1. HÀM HELPER: TẠO HIỆU ỨNG ODOMETER ---
        function updateOdometer(elementId, value) {
            const el = document.getElementById(elementId);
            if (!el) return;

            const valStr = value.toString();
            
            if (!el.classList.contains('odometer-initialized')) {
                el.classList.add('odometer-initialized');
                el.innerHTML = ''; 
                valStr.split('').forEach(digit => {
                    el.appendChild(createDigitColumn(digit));
                });
            } else {
                if (el.children.length !== valStr.length) {
                    el.innerHTML = '';
                    valStr.split('').forEach(digit => {
                        el.appendChild(createDigitColumn(digit));
                    });
                } else {
                    Array.from(el.children).forEach((col, i) => {
                        const digit = valStr[i];
                        const strip = col.querySelector('.digit-strip');
                        strip.style.transform = `translateY(-${parseInt(digit) * 10}%)`;
                    });
                }
            }
        }

        function createDigitColumn(initialDigit) {
            const container = document.createElement('div');
            container.className = 'digit-container';
            const strip = document.createElement('div');
            strip.className = 'digit-strip';
            for (let i = 0; i <= 9; i++) {
                const num = document.createElement('span');
                num.innerText = i;
                strip.appendChild(num);
            }
            strip.style.transform = `translateY(-${parseInt(initialDigit) * 10}%)`;
            container.appendChild(strip);
            return container;
        }

        // --- 2. HÀM LẤY SỐ LIỆU TĨNH ---
        window.fetchGeneralStats = async function () {
            const res = await window.api('/api/admin/dashboard/stats/general');
            if (res && res.status === 'success') {
                document.getElementById('statUsers').innerText = res.data.total_users;
                document.getElementById('statGuests').innerText = res.data.total_guests;
            }
        }

        // --- 3. HÀM LẤY ONLINE ---
        window.fetchOnlineStats = async function () {
            const el = document.getElementById('statOnline');
            if (!el) return; 

            const res = await window.api('/api/admin/dashboard/stats/online');
            if (res && res.status === 'success') {
                updateOdometer('statOnline', res.online);
            }
        }

        // --- KHỞI CHẠY ---
        window.fetchGeneralStats();
        window.fetchOnlineStats();

        if (onlineInterval) clearInterval(onlineInterval);
        onlineInterval = setInterval(() => {
            if (document.getElementById('statOnline')) {
                window.fetchOnlineStats();
            } else {
                clearInterval(onlineInterval);
            }
        }, 30000);
    }
</script>