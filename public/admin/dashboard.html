<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-gray-800 fw-bold"><i class="bi bi-speedometer2"></i> Tổng Quan Hệ Thống</h4>
        <div>
            <span class="text-muted small me-2">Cập nhật realtime: <span
                    class="badge bg-success pulse-animation">Bật</span></span>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-xl-4 col-md-6">
            <div class="card shadow border-0 h-100 py-2" style="border-left: 4px solid #1cc88a !important;">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Đang hoạt động (Live)</div>
                            <div class="h3 mb-0 font-weight-bold text-gray-800 d-flex align-items-center" style="height: 1.2em; overflow: hidden;" id="statOnline">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-broadcast text-success fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-md-6">
            <div class="card shadow border-0 h-100 py-2" style="border-left: 4px solid #4e73df !important;">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Tổng Thành Viên</div>
                            <div class="h3 mb-0 font-weight-bold text-gray-800" id="statUsers">...</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-people-fill text-primary fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-md-6">
            <div class="card shadow border-0 h-100 py-2" style="border-left: 4px solid #36b9cc !important;">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Tài khoản Khách</div>
                            <div class="h3 mb-0 font-weight-bold text-gray-800" id="statGuests">...</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-person-badge text-info fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="bi bi-hourglass-bottom"></i> Guest không hoạt động (>30 ngày)
                    </h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.fetchInactiveGuests()">
                        <i class="bi bi-arrow-clockwise"></i> Tải lại danh sách
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light sticky-top">
                                <tr>
                                    <th class="ps-4">Username/ID</th>
                                    <th>Ngày tạo</th>
                                    <th>Hoạt động cuối</th>
                                    <th class="text-center">Số ngày vắng</th>
                                    <th class="text-center">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="guestTrashTable">
                                <tr>
                                    <td colspan="5" class="text-center py-3">Đang kiểm tra dữ liệu...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white small text-muted">
                    * Danh sách chỉ hiển thị tối đa 100 tài khoản lâu nhất để tối ưu hiệu năng.
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* --- CSS CHO HIỆU ỨNG ODOMETER (LẬT SỐ) --- */
    .digit-container {
        display: inline-block;
        overflow: hidden;
        height: 1.2em; /* Chiều cao bằng đúng 1 dòng chữ */
        line-height: 1.2em;
        position: relative;
    }

    .digit-strip {
        display: flex;
        flex-direction: column;
        transition: transform 0.8s cubic-bezier(0.1, 0.7, 0.1, 1); /* Hiệu ứng trượt mượt mà */
        will-change: transform;
    }

    .digit-strip span {
        height: 1.2em;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<script>
    {
        // Biến lưu interval để clear khi chuyển trang
        let onlineInterval;

        // --- 1. HÀM HELPER: TẠO HIỆU ỨNG ODOMETER ---
        function updateOdometer(elementId, value) {
            const el = document.getElementById(elementId);
            if (!el) return;

            const valStr = value.toString();
            
            // Nếu chưa có cấu trúc odometer (lần đầu chạy), ta tạo khung
            if (!el.classList.contains('odometer-initialized')) {
                el.classList.add('odometer-initialized');
                el.innerHTML = ''; // Xóa spinner
                
                // Tạo các cột số cho từng chữ số
                valStr.split('').forEach(digit => {
                    el.appendChild(createDigitColumn(digit));
                });
            } else {
                // Nếu số lượng chữ số thay đổi (ví dụ 99 -> 100), rebuild lại
                if (el.children.length !== valStr.length) {
                    el.innerHTML = '';
                    valStr.split('').forEach(digit => {
                        el.appendChild(createDigitColumn(digit));
                    });
                } else {
                    // Cập nhật vị trí cho từng cột
                    Array.from(el.children).forEach((col, i) => {
                        const digit = valStr[i];
                        const strip = col.querySelector('.digit-strip');
                        // Di chuyển dải số đến vị trí của số mới
                        // Số 0 ở vị trí 0%, số 9 ở vị trí -90%
                        strip.style.transform = `translateY(-${parseInt(digit) * 10}%)`;
                    });
                }
            }
        }

        // Tạo 1 cột chứa dải số từ 0 đến 9
        function createDigitColumn(initialDigit) {
            const container = document.createElement('div');
            container.className = 'digit-container';
            
            const strip = document.createElement('div');
            strip.className = 'digit-strip';
            
            // Tạo dải số 0-9
            for (let i = 0; i <= 9; i++) {
                const num = document.createElement('span');
                num.innerText = i;
                strip.appendChild(num);
            }
            
            // Set vị trí ban đầu
            strip.style.transform = `translateY(-${parseInt(initialDigit) * 10}%)`;
            
            container.appendChild(strip);
            return container;
        }


        // --- 2. HÀM LẤY SỐ LIỆU TĨNH ---
        window.fetchGeneralStats = async function () {
            const res = await window.api('/api/admin/dashboard/stats/general');
            if (res && res.status === 'success') {
                document.getElementById('statUsers').innerText = res.data.total_users;
                document.getElementById('statGuests').innerText = res.data.total_guests;
            }
        }

        // --- 3. HÀM LẤY ONLINE (Cập nhật dùng Odometer) ---
        window.fetchOnlineStats = async function (isFirstRun = false) {
            const el = document.getElementById('statOnline');
            if (!el) return; 

            const res = await window.api('/api/admin/dashboard/stats/online');

            if (res && res.status === 'success') {
                const newValue = res.online;
                
                // Gọi hàm Odometer thay vì gán text thông thường
                updateOdometer('statOnline', newValue);
            }
        }

        // --- 4. HÀM LẤY DANH SÁCH GUEST RÁC (Giữ nguyên) ---
        window.fetchInactiveGuests = async function () {
            const tbody = document.getElementById('guestTrashTable');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-3"><div class="spinner-border spinner-border-sm text-warning"></div> Đang tải...</td></tr>';

            const res = await window.api('/api/admin/dashboard/guests/inactive');

            if (res && res.status === 'success') {
                const guests = res.data;
                if (guests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-success"><i class="bi bi-check-circle fs-4"></i><br>Hệ thống sạch sẽ! Không có guest nào vắng > 30 ngày.</td></tr>';
                    return;
                }
                tbody.innerHTML = guests.map(g => `
                    <tr id="guest-row-${g.id}">
                        <td class="ps-4">
                            <div class="fw-bold text-dark">${g.username || 'No Name'}</div>
                            <div class="small text-muted text-truncate" style="max-width: 150px;">${g.id}</div>
                        </td>
                        <td class="small">${new Date(g.created_at).toLocaleDateString('vi-VN')}</td>
                        <td class="small">${new Date(g.last_active_at).toLocaleDateString('vi-VN')}</td>
                        <td class="text-center">
                            <span class="badge bg-danger rounded-pill">${g.days_inactive} ngày</span>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger" onclick="window.deleteSingleGuest('${g.id}')" title="Xóa vĩnh viễn">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Lỗi: ${res?.message}</td></tr>`;
            }
        }

        // --- 5. HÀM XÓA 1 GUEST (Giữ nguyên) ---
        window.deleteSingleGuest = async function (id) {
            if (!confirm('Bạn chắc chắn muốn xóa vĩnh viễn Guest này?')) return;
            const row = document.getElementById(`guest-row-${id}`);
            if (row) row.style.opacity = '0.5';
            const res = await window.api(`/api/admin/dashboard/guests/${id}`, { method: 'DELETE' });
            if (res && res.status === 'success') {
                if (row) row.remove();
                const tbody = document.getElementById('guestTrashTable');
                if (tbody.children.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-success">Đã dọn sạch!</td></tr>';
                }
            } else {
                alert('Lỗi: ' + (res?.message || 'Không xóa được'));
                if (row) row.style.opacity = '1';
            }
        }

        // --- KHỞI CHẠY ---
        window.fetchGeneralStats();
        window.fetchInactiveGuests();
        window.fetchOnlineStats(true);

        if (onlineInterval) clearInterval(onlineInterval);
        onlineInterval = setInterval(() => {
            if (document.getElementById('statOnline')) {
                window.fetchOnlineStats(false);
            } else {
                clearInterval(onlineInterval);
            }
        }, 30000);
    }
</script>