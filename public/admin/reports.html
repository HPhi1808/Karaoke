<style>
    .target-preview {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .target-img {
        width: 45px;
        height: 45px;
        border-radius: 6px;
        object-fit: cover;
        border: 1px solid #dee2e6;
    }

    .reporter-info {
        font-size: 0.9rem;
    }

    .reason-badge {
        font-size: 0.85rem;
        padding: 5px 8px;
        border-radius: 4px;
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }

    .status-badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .status-pending {
        background: #ffeeba;
        color: #856404;
    }

    .status-resolved {
        background: #d4edda;
        color: #155724;
    }

    .status-rejected {
        background: #e2e3e5;
        color: #383d41;
    }

    .comment-bubble {
        background: #f0f2f5;
        padding: 8px 12px;
        border-radius: 15px;
        border-top-left-radius: 2px;
        font-size: 0.9rem;
        color: #333;
        display: inline-block;
        max-width: 100%;
    }
</style>

<div class="card shadow border-0 mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h5 class="m-0 font-weight-bold text-danger"><i class="bi bi-flag-fill"></i> Quản lý Khiếu nại & Báo cáo</h5>
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="statusFilter" id="filterPending" value="pending" checked
                onclick="filterReports('pending')">
            <label class="btn btn-outline-danger" for="filterPending">Chờ xử lý</label>
            <input type="radio" class="btn-check" name="statusFilter" id="filterHistory" value="history"
                onclick="filterReports('history')">
            <label class="btn btn-outline-secondary" for="filterHistory">Lịch sử</label>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3" style="width: 35%;">Đối tượng bị báo cáo</th>
                        <th style="width: 20%;">Lý do</th>
                        <th style="width: 20%;">Người báo cáo</th>
                        <th style="width: 10%;">Thời gian</th>
                        <th class="text-center" style="width: 15%;">Hành động</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="descModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết báo cáo</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Lý do chính:</strong> <span id="modalReason"></span></p>
                <hr>
                <p><strong>Mô tả thêm:</strong></p>
                <div class="p-3 bg-light rounded" id="modalDesc"></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">Đóng</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="actionModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-shield-exclamation"></i> Xử lý vi phạm</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="actReportId">
                <input type="hidden" id="actTargetType"> <input type="hidden" id="actTargetId"> <input type="hidden"
                    id="actOffenderId">
                <div class="alert alert-warning small">
                    <i class="bi bi-info-circle-fill"></i> Hãy chọn các biện pháp chế tài phù hợp:
                </div>

                <div class="mb-3 ps-2">
                    <div id="boxDeleteTarget" class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="chkDelete" checked>
                        <label class="form-check-label text-danger fw-bold" for="chkDelete" id="lblDelete">
                            <i class="bi bi-trash"></i> Xóa nội dung này
                        </label>
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="chkWarn" onchange="toggleWarnOptions()">
                        <label class="form-check-label text-dark fw-bold" for="chkWarn">
                            <i class="bi bi-envelope-exclamation"></i> Gửi cảnh báo cho người dùng
                        </label>
                    </div>
                    <div id="warnOptions" class="ms-4 mt-2 p-3 bg-light rounded border" style="display: none;">
                        <div class="mb-2">
                            <label class="form-label small text-muted">Tiêu đề:</label>
                            <input type="text" id="warnTitle" class="form-control form-control-sm"
                                value="Cảnh báo vi phạm tiêu chuẩn cộng đồng">
                        </div>
                        <div>
                            <label class="form-label small text-muted">Nội dung:</label>
                            <textarea id="warnMsg" class="form-control form-control-sm" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="chkLock" onchange="toggleLockOptions()">
                        <label class="form-check-label text-dark fw-bold" for="chkLock">
                            <i class="bi bi-lock-fill"></i> Khóa tài khoản người dùng
                        </label>
                    </div>
                    <div id="lockOptions" class="ms-4 mt-2 p-3 bg-light rounded border" style="display: none;">
                        <label class="form-label small text-muted">Thời gian khóa:</label>
                        <select id="lockDuration" class="form-select form-select-sm">
                            <option value="1h">1 giờ</option>
                            <option value="24h">24 giờ</option>
                            <option value="7d" selected>7 ngày</option>
                            <option value="forever">Vĩnh viễn</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" onclick="submitAction()">
                    Xác nhận & Hoàn tất
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    {
        const REPORT_API = '/api/admin/reports';
        const USER_API = '/api/admin/users';
        // Giả sử bạn sẽ thêm các API xóa Moment/Comment
        // const MOMENT_API = '/api/admin/moments'; 
        // const COMMENT_API = '/api/admin/comments';


        let allReports = [];
        let currentFilter = 'pending';
        let realtimeChannel = null;

        // --- 1. HÀM TẠO HTML CHO ĐỐI TƯỢNG BỊ REPORT ---
        function renderTarget(rp) {
            if (rp.target_type === 'song') {
                if (rp.song_title) {
                    return `
                    <div class="target-preview">
                        <img src="${rp.song_image || 'https://placehold.co/50'}" class="target-img" onerror="this.src='https://placehold.co/50'">
                        <div>
                            <div class="fw-bold text-dark">${rp.song_title}</div>
                            <div class="small text-muted">${rp.song_artist || 'Unknown'}</div>
                        </div>
                    </div>
                `;
                }
                return `<div class="text-muted fst-italic">Bài hát đã bị xóa</div>`;
            }
            else if (rp.target_type === 'user') {
                if (rp.target_user_email) return `<div class="target-preview"><img src="${rp.target_user_avatar || 'https://placehold.co/50?text=U'}" class="target-img rounded-circle border"><div><div class="fw-bold text-dark">${rp.target_user_name || 'No Name'}</div><div class="small text-primary">${rp.target_user_email}</div></div></div>`;
                return `<div class="text-muted">User ID: ${rp.target_id} (Đã xóa)</div>`;
            }
            else if (rp.target_type === 'moment') {
                if (rp.moment_desc !== null) {
                    const ownerName = rp.moment_owner_name || 'Người dùng ẩn danh';
                    // Audio player nhỏ gọn
                    return `
                    <div class="d-flex flex-column gap-1">
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <span class="badge bg-light text-dark border">
                                <i class="bi bi-person-fill"></i> ${ownerName}
                            </span>
                        </div>
                        
                        <div class="target-preview p-2 border rounded bg-white">
                            <div class="d-flex align-items-center gap-2 w-100">
                                <div class="bg-light d-flex align-items-center justify-content-center border rounded" style="width:40px; height:40px; flex-shrink:0;">
                                    <i class="bi bi-mic-fill text-danger"></i>
                                </div>
                                <div style="flex:1; min-width:0;">
                                    <div class="fw-bold text-dark text-truncate small">${rp.moment_desc || 'Không có mô tả'}</div>
                                    <audio controls src="${rp.moment_audio}" style="height: 25px; width: 100%; margin-top: 4px;"></audio>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }
                return `<div class="text-muted fst-italic">Moment ID: ${rp.target_id} (Đã xóa)</div>`;
            }
            else if (rp.target_type === 'comment') {
                if (rp.comment_content) {
                    const userName = rp.comment_owner_name || 'Người dùng';
                    const userAvatar = rp.comment_owner_avatar || 'https://placehold.co/35?text=C';
                    return `<div class="d-flex align-items-start gap-2"><img src="${userAvatar}" class="rounded-circle border" style="width:35px;height:35px;object-fit:cover;" onerror="this.src='https://placehold.co/35'"><div><div class="fw-bold" style="font-size: 0.85rem; margin-bottom: 2px;">${userName}</div><div class="comment-bubble">${rp.comment_content}</div></div></div>`;
                }
                return `<div class="text-muted fst-italic"><i class="bi bi-chat-square-x"></i> Bình luận đã bị xóa</div>`;
            }
            return `<div>ID: ${rp.target_id} <span class="badge bg-secondary">${rp.target_type}</span></div>`;
        }

        // --- 2. HÀM TẠO HTML 1 DÒNG ---
        function generateReportRow(rp) {
            const reporterName = rp.reporter_name || rp.reporter_email || 'Ẩn danh';
            const dateStr = new Date(rp.created_at).toLocaleString('vi-VN');
            const hasDesc = rp.description && rp.description.trim() !== '';

            let actions = '';
            if (rp.status === 'pending') {
                if (rp.target_type === 'song') {
                    // Bài hát thì xử lý đơn giản
                    actions = `<div class="btn-group"><button class="btn btn-sm btn-success" onclick="updateReportStatus('${rp.id}', 'resolved')"><i class="bi bi-check-lg"></i> Xử lý</button><button class="btn btn-sm btn-outline-secondary" onclick="updateReportStatus('${rp.id}', 'rejected')"><i class="bi bi-x-lg"></i> Bỏ qua</button></div>`;
                } else {
                    // User, Moment, Comment thì mở Modal Xử lý
                    // Xác định offenderId (người vi phạm)
                    let offenderId = '';
                    if (rp.target_type === 'user') offenderId = rp.target_id;
                    else if (rp.target_type === 'moment') offenderId = rp.moment_owner_id;
                    else if (rp.target_type === 'comment') offenderId = rp.comment_owner_id;

                    actions = `
                    <div class="btn-group">
                        <button class="btn btn-sm btn-danger fw-bold" 
                            onclick="openActionModal('${rp.id}', '${rp.target_type}', '${rp.target_id}', '${offenderId}')" 
                            title="Xử lý vi phạm">
                            <i class="bi bi-hammer"></i> Xử lý
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="updateReportStatus('${rp.id}', 'rejected')" title="Bỏ qua">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                `;
                }
            } else {
                const statusClass = rp.status === 'resolved' ? 'status-resolved' : 'status-rejected';
                const statusText = rp.status === 'resolved' ? 'Đã giải quyết' : 'Đã từ chối';
                const resolver = rp.resolver_name || rp.resolver_email || 'Admin';
                actions = `<div class="d-flex flex-column align-items-center"><span class="status-badge ${statusClass} mb-1">${statusText}</span><small class="text-muted" style="font-size: 0.75rem;">bởi: <strong>${resolver}</strong></small></div>`;
            }

            return `
            <tr>
                <td class="ps-3">${renderTarget(rp)}</td>
                <td><div class="fw-bold text-danger mb-1">${rp.reason}</div>${hasDesc ? `<button class="btn btn-link btn-sm p-0 text-decoration-none" onclick="showDescModal('${encodeURIComponent(rp.reason)}', '${encodeURIComponent(rp.description)}')">Xem mô tả <i class="bi bi-eye"></i></button>` : ''}</td>
                <td><div class="reporter-info"><i class="bi bi-person-circle text-secondary"></i> ${reporterName}</div></td>
                <td class="text-muted small">${dateStr}</td>
                <td class="text-center">${actions}</td>
            </tr>
        `;
        }

        window.openActionModal = function (reportId, targetType, targetId, offenderId) {
            document.getElementById('actReportId').value = reportId;
            document.getElementById('actTargetType').value = targetType;
            document.getElementById('actTargetId').value = targetId;
            document.getElementById('actOffenderId').value = offenderId;

            // Reset form UI
            const boxDelete = document.getElementById('boxDeleteTarget');
            const lblDelete = document.getElementById('lblDelete');
            const txtWarnMsg = document.getElementById('warnMsg');

            document.getElementById('chkDelete').checked = false;
            document.getElementById('chkWarn').checked = false;
            document.getElementById('chkLock').checked = false;
            toggleWarnOptions();
            toggleLockOptions();

            // CẤU HÌNH GIAO DIỆN THEO TYPE
            if (targetType === 'user') {
                boxDelete.style.display = 'none'; // Không có xóa user ở đây
                txtWarnMsg.value = "Tài khoản của bạn đã bị báo cáo vì vi phạm tiêu chuẩn cộng đồng. Vui lòng tuân thủ quy định nếu không tài khoản sẽ bị khóa.";
            }
            else if (targetType === 'moment') {
                boxDelete.style.display = 'block';
                lblDelete.innerHTML = '<i class="bi bi-trash"></i> Xóa bài đăng (Moment) này';
                document.getElementById('chkDelete').checked = true; // Mặc định xóa
                txtWarnMsg.value = "Bài đăng (Moment) của bạn đã bị xóa do vi phạm quy tắc cộng đồng.";
            }
            else if (targetType === 'comment') {
                boxDelete.style.display = 'block';
                lblDelete.innerHTML = '<i class="bi bi-trash"></i> Xóa bình luận này';
                document.getElementById('chkDelete').checked = true; // Mặc định xóa
                txtWarnMsg.value = "Bình luận của bạn có nội dung không phù hợp và đã bị xóa.";
            }

            new bootstrap.Modal(document.getElementById('actionModal')).show();
        }

        window.toggleWarnOptions = function () {
            document.getElementById('warnOptions').style.display = document.getElementById('chkWarn').checked ? 'block' : 'none';
        }
        window.toggleLockOptions = function () {
            document.getElementById('lockOptions').style.display = document.getElementById('chkLock').checked ? 'block' : 'none';
        }

        window.submitAction = async function () {
            const reportId = document.getElementById('actReportId').value;
            const type = document.getElementById('actTargetType').value;
            const targetId = document.getElementById('actTargetId').value;
            const offenderId = document.getElementById('actOffenderId').value;

            const isDelete = document.getElementById('chkDelete').checked;
            const isWarn = document.getElementById('chkWarn').checked;
            const isLock = document.getElementById('chkLock').checked;

            if ((type !== 'user' && !isDelete && !isWarn && !isLock) || (type === 'user' && !isWarn && !isLock)) {
                alert("Vui lòng chọn ít nhất một hành động!");
                return;
            }

            if (!confirm("Xác nhận xử lý vi phạm?")) return;

            bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();

            try {
                // 1. XÓA NỘI DUNG (Moment / Comment)
                if (isDelete && type !== 'user') {
                    let deleteEndpoint = '';
                    // ⚠️ BẠN CẦN ĐẢM BẢO CÓ API XÓA NÀY TRÊN BACKEND
                    if (type === 'moment') deleteEndpoint = `/api/admin/moments/${targetId}`;
                    if (type === 'comment') deleteEndpoint = `/api/admin/comments/${targetId}`; // Hoặc route xử lý xóa comment

                    if (deleteEndpoint) {
                        console.log(`[Calling] DELETE ${deleteEndpoint}`);
                        // await window.api(deleteEndpoint, { method: 'DELETE' }); 
                        // Tạm thời tôi comment lại vì chưa có file adminMoments.js, bạn cần tự thêm
                    }
                }

                // 2. GỬI CẢNH BÁO
                if (isWarn && offenderId && offenderId !== 'null') {
                    const title = document.getElementById('warnTitle').value;
                    const message = document.getElementById('warnMsg').value;
                    await window.api(`${USER_API}/${offenderId}/message`, {
                        method: 'POST',
                        body: JSON.stringify({ title, message, type: 'warning' })
                    });
                }

                // 3. KHÓA TÀI KHOẢN
                if (isLock && offenderId && offenderId !== 'null') {
                    const duration = document.getElementById('lockDuration').value;
                    await window.api(`${USER_API}/${offenderId}/lock`, {
                        method: 'POST',
                        body: JSON.stringify({ duration })
                    });
                }

                // 4. CẬP NHẬT TRẠNG THÁI REPORT -> RESOLVED
                await window.api(`${REPORT_API}/${reportId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'resolved' })
                });

                alert("Xử lý thành công!");
                fetchReports();

            } catch (e) {
                alert("Lỗi: " + e.message);
                console.error(e);
            }
        }

        // --- 3. TẢI DỮ LIỆU ---
        window.fetchReports = async function (isBackground = false) {
            // Nếu là background fetch (do realtime gọi) thì không hiện loading spinner
            const tbody = document.getElementById('reportTableBody');
            if (!isBackground && tbody) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-danger"></div></td></tr>';
            }

            try {
                const res = await window.api(REPORT_API);
                if (!res) return;

                allReports = Array.isArray(res) ? res : [];
                renderReportTable();

                // Cập nhật badge
                updateBadge();

            } catch (e) {
                console.error(e);
                if (!isBackground && tbody) tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Lỗi tải dữ liệu: ${e.message}</td></tr>`;
            }
        }

        // --- 4. RENDER VÀ FILTER ---
        window.filterReports = function (type) {
            currentFilter = type;
            renderReportTable();
        }

        function renderReportTable() {
            const tbody = document.getElementById('reportTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            let filtered = [];
            if (currentFilter === 'pending') {
                filtered = allReports.filter(r => r.status === 'pending');
            } else {
                filtered = allReports.filter(r => r.status !== 'pending');
            }

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-muted">
                <i class="bi bi-check2-circle display-4"></i>
                <p class="mt-2">${currentFilter === 'pending' ? 'Tuyệt vời! Không có báo cáo nào chờ xử lý.' : 'Chưa có lịch sử xử lý.'}</p>
            </td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(rp => generateReportRow(rp)).join('');
        }

        function updateBadge() {
            const count = allReports.filter(r => r.status === 'pending').length;
            const badge = document.getElementById('reportCount');
            if (badge) badge.innerText = count > 0 ? count : '';
            if (window.updateGlobalReportBadge) window.updateGlobalReportBadge();
        }

        // --- 5. HÀNH ĐỘNG ---
        window.updateReportStatus = async function (id, status) {
            const actionText = status === 'resolved' ? 'Đánh dấu ĐÃ GIẢI QUYẾT' : 'BỎ QUA';
            if (!confirm(`Bạn muốn ${actionText} báo cáo này?`)) return;

            try {
                const res = await window.api(`${REPORT_API}/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                });

                if (res && res.status === 'success') {
                    // Cập nhật Local ngay lập tức để phản hồi nhanh
                    const idx = allReports.findIndex(r => r.id === id);
                    if (idx !== -1) {
                        allReports[idx].status = status;
                        try {
                            const adminInfo = JSON.parse(localStorage.getItem('admin_info') || '{}');
                            allReports[idx].resolver_name = adminInfo.full_name || 'Bạn';
                            allReports[idx].resolver_email = adminInfo.email;
                        } catch (e) { }
                        renderReportTable();
                        updateBadge();
                    }
                } else {
                    alert('Lỗi: ' + (res?.message || 'Unknown'));
                }
            } catch (e) {
                alert('Lỗi kết nối: ' + e.message);
            }
        }

        window.showDescModal = function (reason, desc) {
            document.getElementById('modalReason').innerText = decodeURIComponent(reason);
            document.getElementById('modalDesc').innerText = decodeURIComponent(desc);
            new bootstrap.Modal(document.getElementById('descModal')).show();
        }

        // --- 6. REALTIME LOGIC ---
        async function initRealtimeReports() {
            if (!sbClient) return;

            const token = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');

            if (token) {
                await sbClient.auth.setSession({
                    access_token: token,
                    refresh_token: refreshToken
                });
            }
            if (realtimeChannel) {
                sbClient.removeChannel(realtimeChannel);
            }
            realtimeChannel = sbClient.channel('admin-reports-changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'reports' },
                    (payload) => {
                        fetchReports(true);
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log("✅ Đã kết nối Realtime thành công!");
                    }
                });
        }
        // KHỞI CHẠY
        fetchReports();
        initRealtimeReports();
    }
</script>