<div class="card shadow border-0 mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h5 class="m-0 font-weight-bold text-primary">Danh s√°ch Ng∆∞·ªùi d√πng</h5>
        <div class="input-group" style="width: 300px;">
            <input type="text" id="searchUser" class="form-control" placeholder="T√¨m t√™n, email...">
            <button class="btn btn-primary">
                <i class="bi bi-search"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="text-center">Avatar</th>
                        <th>H·ªç t√™n</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th class="text-center">
                            <div class="dropdown">
                                <button class="btn btn-link text-dark text-decoration-none dropdown-toggle fw-bold p-0"
                                    type="button" id="roleFilterDropdown" data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                    <span id="roleFilterLabel">Vai tr√≤</span>
                                </button>
                                <ul class="dropdown-menu shadow" aria-labelledby="roleFilterDropdown">
                                    <li><a class="dropdown-item" href="#"
                                            onclick="window.filterRole('all', this)">T·∫•t c·∫£</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#"
                                            onclick="window.filterRole('admin', this)">Admin</a></li>
                                    <li><a class="dropdown-item" href="#"
                                            onclick="window.filterRole('user', this)">User</a></li>
                                </ul>
                            </div>
                        </th>
                        <th>Ng√†y t·∫°o</th>
                        <th class="text-center">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-envelope-exclamation"></i> G·ª≠i Th√¥ng B√°o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="msgForm">
                    <input type="hidden" id="msgUserId">
                    <div class="mb-3">
                        <label class="form-label">Ng∆∞·ªùi nh·∫≠n:</label>
                        <input type="text" class="form-control" id="msgUserName" disabled readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i tin nh·∫Øn</label>
                        <select class="form-select" id="msgType">
                            <option value="warning">‚ö†Ô∏è C·∫£nh b√°o vi ph·∫°m</option>
                            <option value="info">‚ÑπÔ∏è Th√¥ng b√°o h·ªá th·ªëng</option>
                            <option value="success">üéÅ Qu√† t·∫∑ng/Khuy·∫øn kh√≠ch</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ti√™u ƒë·ªÅ</label>
                        <input type="text" class="form-control" id="msgTitle" placeholder="V√≠ d·ª•: C·∫£nh b√°o vi ph·∫°m" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">N·ªôi dung chi ti·∫øt</label>
                        <textarea class="form-control" id="msgContent" rows="4" placeholder="Nh·∫≠p n·ªôi dung..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="window.submitMessage()">G·ª≠i ngay</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="lockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-lock-fill"></i> Kho√° T√†i Kho·∫£n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>B·∫°n ƒëang thao t√°c v·ªõi user: <strong id="lockUserName"></strong></p>
                <input type="hidden" id="lockUserId">

                <div class="mb-3">
                    <label class="form-label fw-bold">Ch·ªçn th·ªùi gian kho√°:</label>
                    <div class="list-group">
                        <label class="list-group-item">
                            <input class="form-check-input me-1" type="radio" name="lockDuration" value="1h" checked>
                            Kho√° 1 Gi·ªù
                        </label>
                        <label class="list-group-item">
                            <input class="form-check-input me-1" type="radio" name="lockDuration" value="24h">
                            Kho√° 24 Gi·ªù (1 ng√†y)
                        </label>
                        <label class="list-group-item">
                            <input class="form-check-input me-1" type="radio" name="lockDuration" value="7d">
                            Kho√° 7 Ng√†y
                        </label>
                        <label class="list-group-item list-group-item-danger">
                            <input class="form-check-input me-1" type="radio" name="lockDuration" value="forever">
                            Kho√° Vƒ©nh Vi·ªÖn (C·∫•m c·ª≠a)
                        </label>
                        <label class="list-group-item list-group-item-success">
                            <input class="form-check-input me-1" type="radio" name="lockDuration" value="unlock">
                            üîì M·ªû KHO√Å (User ho·∫°t ƒë·ªông l·∫°i)
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-danger" onclick="window.submitLock()">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>

<script>
    {
        // --- 1. BI·∫æN C·ª§C B·ªò ---
        let allUsersData = [];
        let currentRoleFilter = 'none';
        let currentSearchTerm = '';
        let hasLoadedData = false;

        // --- 2. H√ÄM SINH HTML CHO 1 D√íNG (D√πng chung) ---
        function generateRowHtml(u, currentUserId, currentUserRole) {
            // [B·∫¢O V·ªÜ] Kh√¥ng render n·∫øu kh√¥ng c√≥ username (ph√≤ng h·ªù)
            if (!u.username) return '';

            const isLocked = u.locked_until && new Date(u.locked_until) > new Date();
            const safeName = (u.full_name || u.username || '').replace(/'/g, "\\'");
            
            let actionButtons = '';
            
            // Logic hi·ªÉn th·ªã n√∫t
            if (u.id !== currentUserId) {
                const canEdit = currentUserRole === 'own' || (currentUserRole === 'admin' && u.role === 'user');
                
                if (canEdit) {
                    if (u.role !== 'own') {
                        const btnClass = u.role === 'admin' ? 'btn-secondary' : 'btn-warning';
                        const btnText = u.role === 'admin' ? 'H·∫° User' : 'L√™n Admin';
                        actionButtons += `<button class="btn btn-sm ${btnClass} me-1" onclick="window.toggleRole('${u.id}','${u.role}')" title="ƒê·ªïi quy·ªÅn">${btnText}</button>`;
                    }

                    const lockIcon = isLocked ? '<i class="bi bi-unlock-fill"></i>' : '<i class="bi bi-lock-fill"></i>';
                    const lockClass = isLocked ? 'btn-success' : 'btn-dark';
                    const lockTitle = isLocked ? 'M·ªü kho√°' : 'Kho√° t√†i kho·∫£n';
                    actionButtons += `<button class="btn btn-sm ${lockClass} me-1" onclick="window.openLockModal('${u.id}', '${safeName}')" title="${lockTitle}">${lockIcon}</button>`;

                    actionButtons += `<button class="btn btn-sm btn-danger me-1" onclick="window.deleteUser('${u.id}')" title="X√≥a"><i class="bi bi-trash"></i></button>`;
                    actionButtons += `<button class="btn btn-sm btn-info text-white" onclick="window.openMsgModal('${u.id}', '${safeName}')" title="G·ª≠i tin"><i class="bi bi-envelope"></i></button>`;
                } else {
                    if (currentUserRole === 'admin' && (u.role === 'admin' || u.role === 'own')) {
                        actionButtons = '<span class="text-muted small fst-italic">Kh√¥ng ƒë·ªß quy·ªÅn</span>';
                    }
                }
            } else {
                actionButtons = '<span class="badge bg-info">B·∫°n</span>';
            }

            const statusBadge = isLocked ? '<span class="badge bg-danger ms-2"><i class="bi bi-lock-fill"></i> Locked</span>' : '';
            const rowClass = isLocked ? 'table-secondary' : '';

            // QUAN TR·ªåNG: Th√™m id="user-row-${u.id}" ƒë·ªÉ d·ªÖ t√¨m v√† replace
            return `
                <tr id="user-row-${u.id}" class="${rowClass}">
                    <td class="text-center">
                        <img src="${u.avatar_url || 'https://pub-4b88f65058c84573bfc0002391a01edf.r2.dev/PictureApp/defautl.jpg'}" class="rounded-circle border" width="40" height="40" style="object-fit: cover;">
                    </td>
                    <td class="fw-bold text-dark">${u.full_name || 'Ch∆∞a ƒë·∫∑t t√™n'} ${statusBadge}</td>
                    <td class="text-muted">@${u.username}</td>
                    <td>${u.email}</td>
                    <td class="text-center">
                        <span class="badge ${u.role === 'own' ? 'bg-dark' : u.role === 'admin' ? 'bg-danger' : 'bg-success'}">
                        ${u.role.toUpperCase()}
                        </span>
                    </td>
                    <td>${new Date(u.created_at).toLocaleDateString('vi-VN')}</td>
                    <td class="text-center">${actionButtons}</td>
                </tr>
            `;
        }

        // --- 3. H√ÄM C·∫¨P NH·∫¨T 1 D√íNG (Kh√¥ng load l·∫°i trang) ---
        function updateLocalRow(userId, newData) {
            // 1. C·∫≠p nh·∫≠t d·ªØ li·ªáu trong m·∫£ng b·ªô nh·ªõ
            const index = allUsersData.findIndex(u => u.id === userId);
            if (index !== -1) {
                // Merge d·ªØ li·ªáu c≈© v·ªõi d·ªØ li·ªáu m·ªõi
                allUsersData[index] = { ...allUsersData[index], ...newData };
                const updatedUser = allUsersData[index];

                // [B·∫¢O V·ªÜ] Check username
                if (!updatedUser.username) return;

                // 2. L·∫•y th√¥ng tin ng∆∞·ªùi ƒëang ƒëƒÉng nh·∫≠p ƒë·ªÉ v·∫Ω l·∫°i n√∫t b·∫•m cho ƒë√∫ng quy·ªÅn
                let currentUserId = null; 
                let currentUserRole = '';
                try {
                    const adminInfo = JSON.parse(localStorage.getItem('admin_info'));
                    currentUserId = adminInfo?.id;
                    currentUserRole = adminInfo?.role;
                } catch(e) {}

                // 3. T√¨m d√≤ng c≈© trong DOM v√† thay th·∫ø b·∫±ng HTML m·ªõi
                const oldRow = document.getElementById(`user-row-${userId}`);
                if (oldRow) {
                    // T·∫°o m·ªôt th·∫ª template t·∫°m ƒë·ªÉ ch·ª©a HTML m·ªõi
                    const temp = document.createElement('tbody');
                    const html = generateRowHtml(updatedUser, currentUserId, currentUserRole);
                    if (html) {
                        temp.innerHTML = html;
                        // Thay th·∫ø d√≤ng c≈©
                        oldRow.replaceWith(temp.firstElementChild);
                    }
                }
            }
        }

        // --- 4. C√ÅC H√ÄM H√ÄNH ƒê·ªòNG (ƒê√£ s·ª≠a ƒë·ªÉ d√πng updateLocalRow) ---
        
        // ƒê·ªîI ROLE
        window.toggleRole = async function (id, currentRole) {
            // [B·∫¢O V·ªÜ]
            const user = allUsersData.find(u => u.id === id);
            if (!user || !user.username) {
                alert('T√†i kho·∫£n ch∆∞a ho√†n t·∫•t ƒëƒÉng k√Ω kh√¥ng th·ªÉ thao t√°c.');
                return;
            }

            const newRole = currentRole === 'admin' ? 'user' : 'admin';
            if (!confirm(`B·∫°n mu·ªën ƒë·ªïi quy·ªÅn user n√†y th√†nh ${newRole.toUpperCase()}?`)) return;

            const res = await window.api(`/api/admin/users/${id}/role`, {
                method: 'PATCH',
                body: JSON.stringify({ role: newRole })
            });

            if (res && res.status === 'success') {
                // ‚úÖ Thay v√¨ loadDataFromServer(), ta c·∫≠p nh·∫≠t c·ª•c b·ªô
                updateLocalRow(id, { role: newRole });
            } else {
                alert('L·ªói: ' + (res?.message || 'Kh√¥ng th·ªÉ ƒë·ªïi quy·ªÅn'));
            }
        };

        // KHO√Å T√ÄI KHO·∫¢N
        window.submitLock = async function () {
            const userId = document.getElementById('lockUserId').value;
            
            // [B·∫¢O V·ªÜ]
            const user = allUsersData.find(u => u.id === userId);
            if (!user || !user.username) {
                alert('T√†i kho·∫£n ch∆∞a ho√†n t·∫•t ƒëƒÉng k√Ω kh√¥ng th·ªÉ thao t√°c.');
                return;
            }

            const duration = document.querySelector('input[name="lockDuration"]:checked').value;
            
            const btn = document.querySelector('#lockModal .btn-danger');
            const originalText = btn.innerText;
            btn.innerText = 'X·ª≠ l√Ω...';
            btn.disabled = true;

            const res = await window.api(`/api/admin/users/${userId}/lock`, {
                method: 'POST',
                body: JSON.stringify({ duration })
            });

            btn.innerText = originalText;
            btn.disabled = false;

            if (res && res.status === 'success') {
                bootstrap.Modal.getInstance(document.getElementById('lockModal')).hide();
                
                // ‚úÖ T√≠nh to√°n th·ªùi gian kho√° gi·∫£ l·∫≠p ƒë·ªÉ c·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
                let newLockedUntil = null;
                if (duration !== 'unlock') {
                    const now = new Date();
                    if (duration === '1h') now.setHours(now.getHours() + 1);
                    if (duration === '24h') now.setDate(now.getDate() + 1);
                    if (duration === '7d') now.setDate(now.getDate() + 7);
                    if (duration === 'forever') now.setFullYear(now.getFullYear() + 100);
                    newLockedUntil = now.toISOString();
                }

                updateLocalRow(userId, { locked_until: newLockedUntil });
                
            } else {
                alert('L·ªói: ' + (res?.message || 'Th·∫•t b·∫°i'));
            }
        }

        // X√ìA USER (X√≥a lu√¥n d√≤ng)
        window.deleteUser = async function (id) {
            // [B·∫¢O V·ªÜ]
            const user = allUsersData.find(u => u.id === id);
            if (!user || !user.username) {
                alert('T√†i kho·∫£n ch∆∞a ho√†n t·∫•t ƒëƒÉng k√Ω kh√¥ng th·ªÉ thao t√°c.');
                return;
            }

            if (!confirm('H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. X√ìA ng∆∞·ªùi d√πng n√†y?')) return;
            const res = await window.api(`/api/admin/users/${id}`, { method: 'DELETE' });
            
            if (res && res.status === 'success') {
                // X√≥a kh·ªèi m·∫£ng d·ªØ li·ªáu
                allUsersData = allUsersData.filter(u => u.id !== id);
                // X√≥a d√≤ng kh·ªèi b·∫£ng (Hi·ªáu ·ª©ng bi·∫øn m·∫•t)
                const row = document.getElementById(`user-row-${id}`);
                if (row) row.remove();
            } else {
                alert('L·ªói: ' + (res?.message || 'Kh√¥ng x√≥a ƒë∆∞·ª£c'));
            }
        };

        // --- C√ÅC H√ÄM KH√ÅC (GI·ªÆ NGUY√äN) ---
        window.openMsgModal = function (userId, userName) {
            // [B·∫¢O V·ªÜ]
            const user = allUsersData.find(u => u.id === userId);
            if (!user || !user.username) {
                alert('Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn cho t√†i kho·∫£n ch∆∞a ho√†n t·∫•t ƒëƒÉng k√Ω.');
                return;
            }

            document.getElementById('msgUserId').value = userId;
            document.getElementById('msgUserName').value = userName;
            document.getElementById('msgTitle').value = '';
            document.getElementById('msgContent').value = '';
            new bootstrap.Modal(document.getElementById('messageModal')).show();
        };

        window.submitMessage = async function () {
            const userId = document.getElementById('msgUserId').value;
            const title = document.getElementById('msgTitle').value;
            const message = document.getElementById('msgContent').value;
            const type = document.getElementById('msgType').value;
            if (!title || !message) { alert('Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!'); return; }
            
            const btn = document.querySelector('#messageModal .btn-primary');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div> ƒêang g·ª≠i...';

            const res = await window.api(`/api/admin/users/${userId}/message`, {
                method: 'POST', body: JSON.stringify({ title, message, type })
            });
            btn.disabled = false; btn.innerHTML = originalText;

            if (res && res.status === 'success') {
                alert('G·ª≠i th√†nh c√¥ng!');
                bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
            } else {
                alert('L·ªói: ' + (res?.message || 'Th·∫•t b·∫°i'));
            }
        };

        window.openLockModal = function (id, name) {
            // [B·∫¢O V·ªÜ]
            const user = allUsersData.find(u => u.id === id);
            if (!user || !user.username) {
                alert('T√†i kho·∫£n ch∆∞a ho√†n t·∫•t ƒëƒÉng k√Ω kh√¥ng th·ªÉ thao t√°c.');
                return;
            }

            document.getElementById('lockUserId').value = id;
            document.getElementById('lockUserName').innerText = name;
            document.querySelector('input[name="lockDuration"][value="24h"]').checked = true;
            new bootstrap.Modal(document.getElementById('lockModal')).show();
        };

        // --- 5. LOGIC L·ªåC & RENDER B·∫¢NG ---
        window.filterRole = async function (role, element) {
            currentRoleFilter = role;
            document.querySelectorAll('.dropdown-item').forEach(el => el.classList.remove('active'));
            if (element) element.classList.add('active');
            const labelMap = { 'all': 'T·∫•t c·∫£', 'admin': 'Admin', 'user': 'User' };
            document.getElementById('roleFilterLabel').innerText = labelMap[role] || 'Vai tr√≤';

            if (!hasLoadedData) await loadDataFromServer();
            else renderTable();
        }

        const searchInput = document.getElementById('searchUser');
        if (searchInput) {
            searchInput.oninput = function (e) {
                currentSearchTerm = e.target.value.toLowerCase();
                if (currentRoleFilter === 'none' && currentSearchTerm.length > 0) {
                      currentRoleFilter = 'all';
                      document.getElementById('roleFilterLabel').innerText = 'T·∫•t c·∫£';
                      if (!hasLoadedData) loadDataFromServer();
                      else renderTable();
                } else {
                      renderTable();
                }
            };
        }

        function renderTable() {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            // 1. L·∫•y info ng∆∞·ªùi ƒëang ƒëƒÉng nh·∫≠p TR∆Ø·ªöC TI√äN
            let currentUserId = null; 
            let currentUserRole = '';
            try {
                const adminInfo = JSON.parse(localStorage.getItem('admin_info'));
                currentUserId = adminInfo?.id; 
                currentUserRole = adminInfo?.role;
            } catch (e) {}

            if (currentRoleFilter === 'none') {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-5 text-muted"><i class="bi bi-funnel display-4"></i><p class="mt-3">Vui l√≤ng ch·ªçn <strong>Vai tr√≤</strong>.</p></td></tr>`;
                return;
            }

            const filteredUsers = allUsersData.filter(u => {
                if (!u.username) return false;

                if (currentUserRole === 'admin' && u.role === 'own') {
                    return false; 
                }

                const matchRole = currentRoleFilter === 'all' || u.role === currentRoleFilter;
                const term = currentSearchTerm;
                const matchSearch = (u.full_name || '').toLowerCase().includes(term) || (u.username || '').toLowerCase().includes(term) || (u.email || '').toLowerCase().includes(term);
                
                return matchRole && matchSearch;
            });

            if (filteredUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.</td></tr>';
                return;
            }

            // D√πng join('') ƒë·ªÉ t·ªëi ∆∞u performance khi n·ªëi chu·ªói HTML
            tbody.innerHTML = filteredUsers.map(u => generateRowHtml(u, currentUserId, currentUserRole)).join('');
        }

        async function loadDataFromServer() {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-primary"></div> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            const data = await window.api('/api/admin/users');
            if (!data || (data.status && data.status !== 'success' && !Array.isArray(data))) {
                 if(data && Array.isArray(data)) {} 
                 else {
                      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">L·ªói: ${data?.message || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu'}</td></tr>`;
                      return;
                 }
            }

            const rawData = Array.isArray(data) ? data : (data.users || []);
            // [LOC DU LIEU] L·ªçc ngay t·ª´ khi nh·∫≠n data t·ª´ server
            allUsersData = rawData.filter(u => u.username && u.username.trim() !== '');
            
            hasLoadedData = true;
            renderTable();
        }

        renderTable();
    }
</script>