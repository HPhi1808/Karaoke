<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-gray-800 fw-bold"><i class="bi bi-person-badge"></i> Quản Lý Tài Khoản Khách</h4>
    </div>

    <div class="row">
        <div class="col-lg-12 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-danger">
                        <i class="bi bi-hourglass-bottom"></i> Guest không hoạt động (>30 ngày)
                    </h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.fetchInactiveGuests()">
                        <i class="bi bi-arrow-clockwise"></i> Tải lại
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Username</th> <th>Ngày tạo</th>
                                    <th>Hoạt động cuối</th>
                                    <th class="text-center">Số ngày vắng</th>
                                    <th class="text-center">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="guestTrashTable">
                                <tr>
                                    <td colspan="5" class="text-center py-3">Đang tải dữ liệu...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white small text-muted">
                    * Danh sách hiển thị tối đa 100 tài khoản khách lâu nhất để tối ưu hiệu năng.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    {
        // --- 1. HÀM LẤY DANH SÁCH GUEST RÁC ---
        window.fetchInactiveGuests = async function () {
            const tbody = document.getElementById('guestTrashTable');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-3"><div class="spinner-border spinner-border-sm text-warning"></div> Đang tải...</td></tr>';

            const res = await window.api('/api/admin/dashboard/guests/inactive');

            if (res && res.status === 'success') {
                const guests = res.data;
                if (guests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-success"><i class="bi bi-check-circle fs-4"></i><br>Không có guest nào vắng quá 30 ngày.</td></tr>';
                    return;
                }
                tbody.innerHTML = guests.map(g => `
                    <tr id="guest-row-${g.id}">
                        <td class="ps-4">
                            <div class="fw-bold text-dark">${g.username || 'No Name'}</div>
                            </td>
                        <td class="small">${new Date(g.created_at).toLocaleDateString('vi-VN')}</td>
                        <td class="small">${new Date(g.last_active_at).toLocaleDateString('vi-VN')}</td>
                        <td class="text-center">
                            <span class="badge bg-danger rounded-pill">${g.days_inactive} ngày</span>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger" onclick="window.deleteSingleGuest('${g.id}')" title="Xóa vĩnh viễn">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Lỗi: ${res?.message}</td></tr>`;
            }
        }

        // --- 2. HÀM XÓA 1 GUEST ---
        window.deleteSingleGuest = async function (id) {
            if (!confirm('Bạn chắc chắn muốn xóa vĩnh viễn Guest này?')) return;
            
            const row = document.getElementById(`guest-row-${id}`);
            if (row) row.style.opacity = '0.5';
            
            const res = await window.api(`/api/admin/dashboard/guests/${id}`, { method: 'DELETE' });
            
            if (res && res.status === 'success') {
                if (row) row.remove();
                // Check nếu xóa hết thì hiện thông báo
                const tbody = document.getElementById('guestTrashTable');
                if (tbody.children.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-success">Đã dọn sạch!</td></tr>';
                }
            } else {
                alert('Lỗi: ' + (res?.message || 'Không xóa được'));
                if (row) row.style.opacity = '1';
            }
        }

        // Tự động chạy khi load trang guests.html
        window.fetchInactiveGuests();
    }
</script>