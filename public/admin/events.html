<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω S·ª± ki·ªán</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body>
    <div class="container-fluid">
        <div class="card shadow border-0 mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-calendar-event"></i> Qu·∫£n l√Ω S·ª± ki·ªán
                </h5>
                <button class="btn btn-primary text-nowrap" onclick="showEventForm()">
                    <i class="bi bi-plus-circle"></i> Th√™m s·ª± ki·ªán
                </button>
            </div>

            <div class="card-body p-0">
                <!-- Modal Popup -->
                <div id="eventModal" class="modal fade" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-music-note-beamed"></i> <span id="modalTitle">Upload S·ª± ki·ªán
                                        M·ªõi</span>
                                </h5>
                                <button type="button" class="btn-close btn-close-white"
                                    data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="eventForm">
                                    <input type="hidden" id="eventId">

                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Ti√™u ƒë·ªÅ <span
                                                    class="text-danger">*</span></label>
                                            <input id="title" class="form-control" placeholder="Vd: S·ª± ki·ªán T·∫øt 2026"
                                                required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Ph·∫ßn th∆∞·ªüng</label>
                                            <input id="rewards" class="form-control"
                                                placeholder="Vd: 1000ƒë, 500ƒë, 300ƒë ho·∫∑c JSON m·∫£ng ph·∫ßn th∆∞·ªüng">
                                        </div>

                                        <div class="col-md-12">
                                            <label class="form-label fw-bold">N·ªôi dung</label>
                                            <textarea id="description" class="form-control" rows="3"
                                                placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ s·ª± ki·ªán..."></textarea>
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Ng√†y b·∫Øt ƒë·∫ßu <span
                                                    class="text-danger">*</span></label>
                                            <input id="start_date" type="datetime-local" class="form-control" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Ng√†y k·∫øt th√∫c</label>
                                            <input id="end_date" type="datetime-local" class="form-control">
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    H·ªßy
                                </button>
                                <button type="submit" form="eventForm" class="btn btn-success">
                                    <i class="bi bi-cloud-upload"></i> Upload Ngay
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-3">Ti√™u ƒë·ªÅ</th>
                                <th>N·ªôi dung</th>
                                <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                                <th>Ng√†y k·∫øt th√∫c</th>
                                <th>Ph·∫ßn th∆∞·ªüng</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="eventsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = '/api/admin/events';
        let allEventsData = [];
        let eventModal;

        // ƒê·ª£i window.api s·∫µn s√†ng
        function waitForApi() {
            return new Promise((resolve) => {
                if (window.api && typeof window.api === 'function') {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (window.api && typeof window.api === 'function') {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                }
            });
        }

        function renderEventsTable() {
            const tbody = document.getElementById('eventsTable');
            tbody.innerHTML = '';

            if (!allEventsData.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            Kh√¥ng c√≥ s·ª± ki·ªán
                        </td>
                    </tr>`;
                return;
            }

            allEventsData.forEach(ev => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${ev.title || ''}</td>
                    <td>${ev.description || ''}</td>
                    <td>${ev.start_date ? new Date(ev.start_date).toLocaleString('vi-VN') : ''}</td>
                    <td>${ev.end_date ? new Date(ev.end_date).toLocaleString('vi-VN') : ''}</td>
                    <td>
                        ${Array.isArray(ev.rewards)
                        ? ev.rewards.map((r, i) => `
                                <span style="display:block;color:${i === 0 ? '#d32f2f' : i === 1 ? '#1976d2' : '#388e3c'}">
                                    ${r.title ? `<b>${r.title}:</b> ` : ''}${r.value}
                                </span>
                              `).join('')
                        : ''}
                    </td>
                    <td>
                        <button class="btn btn-warning btn-sm me-1" onclick="editEvent('${ev.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteEvent('${ev.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function fetchEvents() {
            const tbody = document.getElementById('eventsTable');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="spinner-border text-primary"></div>
                    </td>
                </tr>
            `;

            try {
                await waitForApi();

                console.log('üîç Fetching events from:', API);
                console.log('‚úÖ window.api available:', typeof window.api);

                const data = await window.api(API);

                console.log('üì¶ D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:', data);

                allEventsData = Array.isArray(data) ? data : [];
                renderEventsTable();
            } catch (err) {
                console.error('‚ùå L·ªói t·∫£i d·ªØ li·ªáu:', err);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-4">
                            <i class="bi bi-exclamation-triangle"></i>
                            L·ªói: ${err.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server'}
                        </td>
                    </tr>
                `;
            }
        }

        function showEventForm() {
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            document.getElementById('modalTitle').textContent = 'Upload S·ª± ki·ªán M·ªõi';
            eventModal.show();
        }

        function hideEventForm() {
            eventModal.hide();
        }

        window.editEvent = async function (id) {
            try {
                await waitForApi();

                console.log('‚úèÔ∏è Editing event:', id);
                const ev = await window.api(API + '/' + id);

                document.getElementById('eventId').value = ev.id;
                document.getElementById('title').value = ev.title || '';
                document.getElementById('rewards').value = Array.isArray(ev.rewards) ? JSON.stringify(ev.rewards, null, 2) : '';
                document.getElementById('description').value = ev.description || '';
                document.getElementById('start_date').value = ev.start_date ? ev.start_date.slice(0, 16) : '';
                document.getElementById('end_date').value = ev.end_date ? ev.end_date.slice(0, 16) : '';
                document.getElementById('modalTitle').textContent = 'Ch·ªânh s·ª≠a S·ª± ki·ªán';
                eventModal.show();
            } catch (err) {
                console.error('‚ùå L·ªói t·∫£i s·ª± ki·ªán:', err);
                alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·ª± ki·ªán: ' + (err.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
            }
        }

        window.deleteEvent = async function (id) {
            if (!confirm('Xo√° s·ª± ki·ªán n√†y?')) return;

            try {
                await waitForApi();

                console.log('üóëÔ∏è Deleting event:', id);
                const result = await window.api(API + '/' + id, { method: 'DELETE' });

                console.log('‚úÖ K·∫øt qu·∫£ x√≥a:', result);
                fetchEvents();
            } catch (err) {
                console.error('‚ùå L·ªói x√≥a s·ª± ki·ªán:', err);
                alert('Kh√¥ng th·ªÉ x√≥a s·ª± ki·ªán: ' + (err.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
            }
        }

        document.getElementById('eventForm').onsubmit = async function (e) {
            e.preventDefault();

            try {
                await waitForApi();

                const id = document.getElementById('eventId').value;
                let rewardValue = document.getElementById('rewards').value;
                let rewardsParsed = [];

                if (rewardValue.trim()) {
                    try {
                        rewardsParsed = JSON.parse(rewardValue);
                        if (!Array.isArray(rewardsParsed)) throw new Error('Ph·∫£i l√† m·∫£ng');
                    } catch {
                        let vals = rewardValue.split(/,|\n/).map(v => v.trim()).filter(Boolean);
                        rewardsParsed = [
                            { title: "Gi·∫£i Nh·∫•t", value: vals[0] || "" },
                            { title: "Gi·∫£i Nh√¨", value: vals[1] || vals[0] || "" },
                            { title: "Gi·∫£i Ba", value: vals[2] || vals[0] || "" }
                        ];
                    }
                }

                const data = {
                    title: title.value,
                    description: description.value,
                    start_date: start_date.value,
                    end_date: end_date.value,
                    rewards: rewardsParsed
                };

                console.log('üíæ D·ªØ li·ªáu g·ª≠i ƒëi:', data);
                console.log('üì§ Method:', id ? 'PUT' : 'POST');

                const result = await window.api(id ? API + '/' + id : API, {
                    method: id ? 'PUT' : 'POST',
                    body: JSON.stringify(data)
                });

                console.log('‚úÖ K·∫øt qu·∫£ l∆∞u:', result);
                hideEventForm();
                fetchEvents();
            } catch (err) {
                console.error('‚ùå L·ªói l∆∞u s·ª± ki·ªán:', err);
                alert('Kh√¥ng th·ªÉ l∆∞u s·ª± ki·ªán: ' + (err.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
            }
        };

        (async function init() {
            await waitForApi();
            eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
            fetchEvents();
        })();
    </script>
</body>

</html>