<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <title>Karaoke Admin Panel</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
  <style>
    /* 1. CSS Giao di·ªán (Gi·ªØ nguy√™n) */
    body {
      background: #f0f2f5;
      font-family: 'Segoe UI', sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .navbar {
      background: linear-gradient(45deg, #667eea, #764ba2);
      flex-shrink: 0;
      z-index: 1030;
    }

    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .sidebar {
      width: 260px;
      height: 100%;
      background: #343a40;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .sidebar .nav-link {
      color: #ddd;
      border-radius: 8px;
      margin: 5px 10px;
      cursor: pointer;
    }

    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background: #495057;
      color: white;
    }

    .content-area {
      flex-grow: 1;
      height: 100%;
      background: #f8f9fa;
      overflow-y: auto;
      padding: 1.5rem;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* CSS MODAL */
    .session-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(2px);
    }

    .session-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 25px;
      border-radius: 12px;
      width: 400px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .session-actions {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .session-timer {
      font-size: 1.5rem;
      font-weight: bold;
      color: #dc3545;
      display: block;
      margin: 10px 0;
    }
  </style>
</head>

<body>

  <nav class="navbar navbar-dark shadow sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="bi bi-mic-fill"></i> Karaoke Admin</a>
      <div class="text-white d-flex align-items-center">
        <span class="me-3">Xin ch√†o: <strong id="adminName">Admin</strong></span>
        <button id="btnLogout" class="btn btn-outline-light btn-sm" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
        </button>
      </div>
    </div>
  </nav>

  <div class="d-flex main-container">
    <div class="sidebar p-3 d-none d-md-block" style="width: 260px;">
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link active" onclick="loadPage('dashboard.html', this)"><i
              class="bi bi-speedometer2"></i> T·ªïng quan</a></li>
        <hr class="text-secondary mx-2">
        <li class="nav-item"><a class="nav-link" onclick="loadPage('users.html', this)"><i
              class="bi bi-people-fill"></i> Qu·∫£n l√Ω Users</a></li>
        <li class="nav-item"><a class="nav-link" onclick="loadPage('guests.html', this)"><i
              class="bi bi-person-badge"></i> Qu·∫£n l√Ω Guest</a></li>
        <hr class="text-secondary mx-2">
        <li class="nav-item"><a class="nav-link" onclick="loadPage('songs.html', this)"><i
              class="bi bi-music-note-list"></i> Qu·∫£n l√Ω B√†i h√°t</a></li>
        <li class="nav-item"><a class="nav-link" onclick="loadPage('rooms.html', this)"><i
              class="bi bi-house-door-fill"></i> Ph√≤ng Live</a></li>
        <li class="nav-item"><a class="nav-link" onclick="loadPage('moments.html', this)"><i
              class="bi bi-camera-reels-fill"></i> Kho·∫£nh kh·∫Øc</a></li>
        <hr class="text-secondary mx-2">
        <li class="nav-item"><a class="nav-link" onclick="loadPage('reports.html', this)"><i
              class="bi bi-flag-fill text-warning"></i> Khi·∫øu n·∫°i / Report <span class="badge bg-danger float-end"
              id="reportCount">0</span></a></li>
        <li class="nav-item"><a class="nav-link" onclick="loadPage('notifications.html', this)"><i
              class="bi bi-megaphone-fill text-info"></i> Th√¥ng b√°o h·ªá th·ªëng</a></li>
      </ul>
    </div>

    <div class="flex-grow-1 p-4 content-area">
      <div id="pageContent">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
          <div class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
      </div>
    </div>
  </div>

  <div id="session-modal" class="session-modal">
    <div class="session-content">
      <div class="mb-3"><i class="bi bi-alarm text-warning" style="font-size: 3rem;"></i></div>
      <h4>Phi√™n l√†m vi·ªác s·∫Øp h·∫øt h·∫°n!</h4>
      <p class="text-muted">ƒê·ªÉ b·∫£o m·∫≠t, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ƒëƒÉng xu·∫•t sau:</p>
      <span id="session-countdown" class="session-timer">60</span>
      <p>gi√¢y n·ªØa.</p>
      <div class="session-actions">
        <button onclick="logout()" class="btn btn-secondary"><i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t</button>
        <button onclick="triggerRefreshToken()" class="btn btn-primary" id="btnExtend"><i
            class="bi bi-arrow-clockwise"></i> Gia h·∫°n th√™m</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- 0. KH·ªûI T·∫†O BI·∫æN TO√ÄN C·ª§C ---
    let warningTimer = null;    // Timer d√†i h·∫°n (ng·ªß ƒë√¥ng)
    let countdownInterval = null; // Timer ng·∫Øn h·∫°n (ƒë·∫øm ng∆∞·ª£c 60s tr√™n UI)
    const WARNING_BUFFER = 60;  // B√°o tr∆∞·ªõc 60 gi√¢y

    // --- 1. KI·ªÇM TRA ƒêƒÇNG NH·∫¨P S∆† B·ªò ---
    (function () {
      const token = localStorage.getItem('access_token');
      if (!token) window.location.replace('/admin/login.html');
    })();

    // --- 2. TI·ªÜN √çCH AUTH ---
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) { return null; }
    }

    function isTokenExpired(token) {
      if (!token) return true;
      const decoded = parseJwt(token);
      if (!decoded || !decoded.exp) return true;
      return Date.now() >= (decoded.exp * 1000) - 10000;
    }

    // --- 3. H·∫∏N GI·ªú TH√îNG MINH (Thay th·∫ø v√≤ng l·∫∑p li√™n t·ª•c) ---
    function scheduleSessionWarning() {
      // X√≥a c√°c timer c≈© n·∫øu c√≥
      if (warningTimer) clearTimeout(warningTimer);
      if (countdownInterval) clearInterval(countdownInterval);

      const token = localStorage.getItem('access_token');
      if (!token) return;

      const decoded = parseJwt(token);
      if (!decoded || !decoded.exp) return;

      const now = Math.floor(Date.now() / 1000);
      // T√≠nh th·ªùi gian c√≤n l·∫°i cho ƒë·∫øn l√∫c C·∫¶N B√ÅO (h·∫øt h·∫°n - 60s)
      const secondsUntilWarning = (decoded.exp - now) - WARNING_BUFFER;

      console.log(`üïí Token h·∫øt h·∫°n sau ${decoded.exp - now}s. H·∫πn gi·ªù hi·ªán Modal sau ${secondsUntilWarning}s.`);

      if (secondsUntilWarning > 0) {
        // N·∫øu c√≤n l√¢u m·ªõi h·∫øt h·∫°n -> Ng·ªß ƒë√¥ng
        warningTimer = setTimeout(() => {
          showSessionModal();
        }, secondsUntilWarning * 1000);
      } else {
        // N·∫øu ƒë√£ ƒë·∫øn gi·ªù (ho·∫∑c qu√° gi·ªù) -> Hi·ªán Modal ngay
        showSessionModal();
      }
    }

    // --- 4. HI·ªÇN TH·ªä MODAL V√Ä ƒê·∫æM NG∆Ø·ª¢C ---
    function showSessionModal() {
      const modal = document.getElementById('session-modal');
      const countdownSpan = document.getElementById('session-countdown');

      if (modal.style.display !== 'block') {
        modal.style.display = 'block';
        console.warn("‚ö†Ô∏è ƒêang hi·ªÉn th·ªã c·∫£nh b√°o h·∫øt phi√™n!");
      }

      // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p 1s CH·ªà KHI modal ƒëang hi·ªán (ƒë·ªÉ update s·ªë gi√¢y UI)
      if (countdownInterval) clearInterval(countdownInterval);

      // C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c l·∫ßn ƒë·∫ßu
      updateCountdownUI(countdownSpan);

      countdownInterval = setInterval(() => {
        updateCountdownUI(countdownSpan);
      }, 1000);
    }

    function updateCountdownUI(spanElement) {
      const token = localStorage.getItem('access_token');
      if (!token) return;
      const decoded = parseJwt(token);
      const now = Math.floor(Date.now() / 1000);
      const timeLeft = decoded.exp - now;

      if (timeLeft > 0) {
        spanElement.innerText = timeLeft;
      } else {
        // H·∫øt gi·ªù th·∫≠t s·ª± -> Logout
        clearInterval(countdownInterval);
        handleLogout("Phi√™n l√†m vi·ªác ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
      }
    }

    function hideSessionModal() {
      const modal = document.getElementById('session-modal');
      modal.style.display = 'none';
      if (countdownInterval) clearInterval(countdownInterval);
    }

    // --- 5. LOGIC REFRESH TOKEN (KHI B·∫§M N√öT) ---
    async function performRefreshToken() {
      const rfToken = localStorage.getItem('refresh_token');
      if (!rfToken) return null;

      try {
        console.log("üîÑ ƒêang th·ª±c hi·ªán refresh token...");

        const configRes = await fetch('/api/admin-config');
        if (!configRes.ok) return null;
        const config = await configRes.json();

        const { createClient } = window.supabase;
        const tempClient = createClient(config.supabaseUrl, config.supabaseAnonKey);

        const { data, error } = await tempClient.auth.refreshSession({ refresh_token: rfToken });

        if (error || !data.session) {
          console.error("Refresh th·∫•t b·∫°i:", error);
          return null;
        }

        // L∆∞u Token m·ªõi
        localStorage.setItem('access_token', data.session.access_token);
        localStorage.setItem('refresh_token', data.session.refresh_token);
        console.log("‚úÖ Refresh th√†nh c√¥ng!");

        return data.session.access_token;
      } catch (err) {
        console.error("L·ªói h·ªá th·ªëng khi refresh:", err);
        return null;
      }
    }

    async function triggerRefreshToken() {
      const btn = document.getElementById('btnExtend');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...';

      const newToken = await performRefreshToken();

      if (newToken) {
        hideSessionModal();
        // QUAN TR·ªåNG: Sau khi gia h·∫°n th√†nh c√¥ng, t√≠nh to√°n l·∫°i l·ªãch h·∫πn m·ªõi
        scheduleSessionWarning();

        // Reset UI n√∫t
        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }, 500);
      } else {
        handleLogout("Kh√¥ng th·ªÉ gia h·∫°n phi√™n l√†m vi·ªác.");
      }
    }

    // --- 6. C√ÅC H√ÄM UI KH√ÅC ---
    const adminInfo = localStorage.getItem('admin_info');
    if (adminInfo) {
      try {
        const user = JSON.parse(adminInfo);
        document.getElementById('adminName').innerText = user.full_name || user.email || 'Admin';
      } catch (e) { }
    }

    function handleLogout(message = null) {
      if (message) alert(message);
      localStorage.clear();
      window.location.replace('/admin/login.html');
    }

    async function logout() {
      const btn = document.getElementById('btnLogout');
      if (btn) btn.innerHTML = 'ƒêang xu·∫•t...';
      try {
        const adminInfoStr = localStorage.getItem('admin_info');
        if (adminInfoStr) {
          const user = JSON.parse(adminInfoStr);
          await window.api('/api/auth/logout', { method: 'POST', body: JSON.stringify({ userId: user.id }) });
        }
      } catch (e) { } finally { handleLogout(); }
    }

    // --- 7. WINDOW.API ---
    window.api = async function (url, options = {}) {
      let currentToken = localStorage.getItem('access_token');
      if (isTokenExpired(currentToken)) {
        const newToken = await performRefreshToken();
        if (newToken) {
          currentToken = newToken;
          // C·∫≠p nh·∫≠t l·∫°i l·ªãch h·∫πn n·∫øu refresh t·ª± ƒë·ªông th√†nh c√¥ng
          scheduleSessionWarning();
        } else {
          handleLogout("Phi√™n h·∫øt h·∫°n.");
          return null;
        }
      }

      try {
        const headers = { 'Authorization': `Bearer ${currentToken}`, ...options.headers };
        if (!(options.body instanceof FormData) && !headers['Content-Type']) headers['Content-Type'] = 'application/json';

        const res = await fetch(url, { ...options, headers });

        if (res.status === 401) {
          const retryToken = await performRefreshToken();
          if (retryToken) {
            headers['Authorization'] = `Bearer ${retryToken}`;
            const retryRes = await fetch(url, { ...options, headers });
            if (retryRes.ok) return await retryRes.json();
          }
          handleLogout("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n.");
          return null;
        }
        if (res.status === 403) {
          const err = await res.clone().json().catch(() => ({}));
          if (err.status === 'locked') handleLogout(err.message);
        }
        const data = await res.json();
        if (Array.isArray(data)) return data;
        return { ok: res.ok, status: res.status, ...data };
      } catch (err) { return { status: 'error', message: "L·ªói k·∫øt n·ªëi Server" }; }
    };

    // --- 8. LOAD PAGE ---
    window.loadPage = async function (page, element) {
      localStorage.setItem('last_visited_page', page);
      document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
      if (element) element.classList.add('active');
      else {
        const savedLink = document.querySelector(`.sidebar .nav-link[onclick*="'${page}'"]`);
        if (savedLink) savedLink.classList.add('active');
      }
      const content = document.getElementById('pageContent');
      content.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
      try {
        const res = await fetch(`./${page}`);
        if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y trang");
        const html = await res.text();
        content.innerHTML = html;
        content.querySelectorAll('script').forEach(s => {
          const ns = document.createElement('script');
          ns.textContent = s.textContent;
          document.body.appendChild(ns);
          s.remove();
        });
      } catch (e) { content.innerHTML = `<div class="alert alert-danger m-4">L·ªói: ${e.message}</div>`; }
    };

    // --- 9. REALTIME SECURITY ---
    async function initRealtimeSecurity() {
      // (Gi·ªØ nguy√™n code Realtime c·ªßa b·∫°n)
      const adminInfoStr = localStorage.getItem('admin_info');
      if (!adminInfoStr) return;
      try {
        const response = await fetch('/api/admin-config');
        const config = await response.json();
        const { createClient } = window.supabase;
        const sbClient = createClient(config.supabaseUrl, config.supabaseAnonKey);
        const user = JSON.parse(adminInfoStr);
        const mySessionTimestamp = new Date().getTime();

        console.log("üõ°Ô∏è ƒêang k√≠ch ho·∫°t b·∫£o m·∫≠t Realtime...");

        sbClient.channel('security-check').on('postgres_changes',
          { event: 'UPDATE', schema: 'public', table: 'users', filter: `id=eq.${user.id}` },
          (payload) => {
            if (payload.new.locked_until && new Date(payload.new.locked_until) > new Date())
              handleLogout("T√†i kho·∫£n ƒë√£ b·ªã kh√≥a!");
            if (payload.new.last_sign_in_at) {
              const lastSignIn = new Date(payload.new.last_sign_in_at).getTime();
              if (lastSignIn > mySessionTimestamp + 2000) {
                sbClient.removeAllChannels();
                handleLogout("ƒêƒÉng nh·∫≠p n∆°i kh√°c!");
              }
            }
          }
        ).subscribe();
      } catch (e) { console.error("L·ªói Realtime:", e); }
    }

    // --- 10. KH·ªûI CH·∫†Y ---
    (async () => {
      // B·∫Øt ƒë·∫ßu h·∫πn gi·ªù c·∫£nh b√°o (Scheduling thay v√¨ Polling)
      scheduleSessionWarning();

      const lastPage = localStorage.getItem('last_visited_page');
      if (lastPage) loadPage(lastPage);
      else loadPage('dashboard.html');
      setTimeout(initRealtimeSecurity, 3000);
    })();

    // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng quay l·∫°i Tab (ph√≤ng tr∆∞·ªùng h·ª£p tr√¨nh duy·ªát ng·ªß ƒë√¥ng l√†m l·ªách gi·ªù)
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === 'visible') {
        // T√≠nh to√°n l·∫°i l·ªãch h·∫πn ƒë·ªÉ ƒë·∫£m b·∫£o ch√≠nh x√°c
        scheduleSessionWarning();
      }
    });

  </script>
</body>

</html>