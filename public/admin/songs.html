<style>
    .cover-img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .audio-preview {
        height: 32px;
        width: 360px;
        border-radius: 16px;
    }

    /* Overlay Loading khi Upload */
    #loadingOverlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
</style>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h5 class="mt-3 text-primary fw-bold" id="loadingText">ƒêang x·ª≠ l√Ω file... Vui l√≤ng ƒë·ª£i!</h5>
    <small class="text-muted">Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i gi√¢y ƒë·ªÉ upload l√™n Cloud</small>
</div>

<div class="card shadow border-0 mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h5 class="m-0 font-weight-bold text-primary">üéµ Kho Nh·∫°c Karaoke</h5>
        
        <div class="d-flex gap-2">
            <div class="input-group" style="width: 300px;">
                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                <input type="text" id="searchSong" class="form-control border-start-0" placeholder="T√¨m b√†i h√°t, ca sƒ©...">
            </div>

            <button class="btn btn-primary text-nowrap" onclick="openAddModal()">
                <i class="bi bi-cloud-upload-fill"></i> Th√™m b√†i h√°t
            </button>
        </div>
    </div>

    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3">Cover</th>
                        <th>T√™n b√†i h√°t</th>
                        <th>Ca sƒ©</th>
                        <th>Th·ªÉ lo·∫°i</th>
                        <th>Nghe th·ª≠ (Beat)</th>
                        <th class="text-center">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="songTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="addSongModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-music-note-beamed"></i> Upload B√†i H√°t M·ªõi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addSongForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">T√™n b√†i h√°t <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="title" required placeholder="V√≠ d·ª•: Em c·ªßa ng√†y h√¥m qua">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Ca sƒ© <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="artist" required placeholder="V√≠ d·ª•: S∆°n T√πng M-TP">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Th·ªÉ lo·∫°i</label>
                        <input type="text" class="form-control" name="genre" placeholder="Nh·∫°c tr·∫ª, Remix, Bolero...">
                    </div>

                    <div class="card bg-light border-0 mb-3">
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">1. File Beat (Nh·∫°c n·ªÅn) <span class="text-danger">*</span></label>
                                <input type="file" class="form-control" name="beat" accept=".mp3, .m4a, .wav" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">2. File Lyric (.lrc) <span class="text-danger">*</span></label>
                                <input type="file" class="form-control" name="lyric" accept=".lrc" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">3. File Vocal (H√°t m·∫´u) <span class="text-muted">(T√πy ch·ªçn)</span></label>
                                <input type="file" class="form-control" name="vocal" accept=".mp3, .m4a">
                            </div>
                            <div class="mb-0">
                                <label class="form-label fw-bold">4. ·∫¢nh b√¨a <span class="text-danger">*</span></label>
                                <input type="file" class="form-control" name="image" accept="image/*" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success fw-bold" onclick="submitSong()">
                    <i class="bi bi-cloud-arrow-up-fill"></i> Upload Ngay
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editSongModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> C·∫≠p nh·∫≠t b√†i h√°t</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSongForm">
                    <input type="hidden" id="editSongId" name="id">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">T√™n b√†i h√°t</label>
                            <input type="text" class="form-control" id="editTitle" name="title" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Ca sƒ©</label>
                            <input type="text" class="form-control" id="editArtist" name="artist" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Th·ªÉ lo·∫°i</label>
                            <input type="text" class="form-control" id="editGenre" name="genre">
                        </div>
                    </div>
                    
                    <div class="alert alert-info py-2 small">
                        <i class="bi bi-info-circle"></i> Ch·ªâ ch·ªçn file n·∫øu b·∫°n mu·ªën thay ƒë·ªïi file c≈©.
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">ƒê·ªïi Beat</label>
                            <input type="file" class="form-control form-control-sm" name="beat" accept=".mp3,.m4a">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">ƒê·ªïi Lyric</label>
                            <input type="file" class="form-control form-control-sm" name="lyric" accept=".lrc">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">ƒê·ªïi Vocal</label>
                            <input type="file" class="form-control form-control-sm" name="vocal" accept=".mp3">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">ƒê·ªïi ·∫¢nh</label>
                            <input type="file" class="form-control form-control-sm" name="image" accept="image/*">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary fw-bold" onclick="updateSong()">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>
</div>

<script>
    {
        const SONG_API_URL = '/api/admin/songs';
        let allSongsData = []; // Cache d·ªØ li·ªáu

        // --- 1. H√ÄM SINH HTML CHO 1 D√íNG) ---
        function generateSongRow(song) {
            const safeTitle = (song.title || '').replace(/'/g, "\\'");
            const safeArtist = (song.artist_name || '').replace(/'/g, "\\'");
            const safeGenre = (song.genre || '').replace(/'/g, "\\'");

            return `
                <tr id="song-row-${song.song_id}">
                    <td class="ps-3">
                        <img src="${song.image_url || 'https://via.placeholder.com/50'}" class="cover-img" onerror="this.src='https://via.placeholder.com/50'">
                    </td>
                    <td class="fw-bold text-dark">${song.title}</td>
                    <td class="text-secondary">${song.artist_name}</td>
                    <td><span class="badge bg-light text-dark border">${song.genre || 'N/A'}</span></td>
                    <td>
                        ${song.beat_url 
                            ? `<audio controls src="${song.beat_url}" class="audio-preview" preload="none"></audio>` 
                            : '<span class="text-muted small fst-italic">Ch∆∞a c√≥ beat</span>'}
                    </td>
                    <td class="text-center">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-warning" 
                                onclick="window.openEditModal(${song.song_id}, '${safeTitle}', '${safeArtist}', '${safeGenre}')" 
                                title="S·ª≠a">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" 
                                onclick="window.deleteSong(${song.song_id})" 
                                title="X√≥a">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // --- 2. H√ÄM T·∫¢I D·ªÆ LI·ªÜU ---
        window.fetchSongs = async function() {
            const tbody = document.getElementById('songTableBody');
            if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2 text-muted">ƒêang t·∫£i danh s√°ch b√†i h√°t...</div></td></tr>';

            try {
                let response = await window.api(SONG_API_URL);

                if (!response) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-4">Kh√¥ng th·ªÉ k·∫øt n·ªëi Server!</td></tr>';
                    return;
                }

                let songs = [];
                if (Array.isArray(response)) {
                    songs = response;
                } else {
                    songs = Object.values(response).filter(item => item && typeof item === 'object' && item.song_id);
                }

                // S·∫Øp x·∫øp b√†i m·ªõi nh·∫•t l√™n ƒë·∫ßu (n·∫øu API ch∆∞a s·∫Øp x·∫øp)
                songs.sort((a, b) => b.song_id - a.song_id);

                allSongsData = songs;
                renderSongTable();

            } catch (error) {
                console.error('L·ªói t·∫£i danh s√°ch:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">L·ªói: ${error.message}</td></tr>`;
            }
        }

        // --- 3. H√ÄM V·∫º B·∫¢NG ---
        function renderSongTable() {
            const tbody = document.getElementById('songTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const term = document.getElementById('searchSong').value.toLowerCase().trim();

            const filteredSongs = allSongsData.filter(song => {
                const title = (song.title || '').toLowerCase();
                const artist = (song.artist_name || '').toLowerCase();
                const genre = (song.genre || '').toLowerCase();
                return title.includes(term) || artist.includes(term) || genre.includes(term);
            });

            if (filteredSongs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted"><i class="bi bi-inbox display-4"></i><p class="mt-2">Kh√¥ng t√¨m th·∫•y b√†i h√°t n√†o.</p></td></tr>';
                return;
            }

            tbody.innerHTML = filteredSongs.map(song => generateSongRow(song)).join('');
        }

        // T√åM KI·∫æM
        const searchInput = document.getElementById('searchSong');
        if (searchInput) {
            searchInput.oninput = function() { renderSongTable(); };
        }

        // --- 4. C√ÅC H√ÄM X·ª¨ L√ù (ADD, EDIT, DELETE) ---

        // ======================= TH√äM B√ÄI H√ÅT =======================
        window.openAddModal = function() {
             document.getElementById('addSongForm').reset();
             new bootstrap.Modal(document.getElementById('addSongModal')).show();
        }

        window.submitSong = async function() {
            const form = document.getElementById('addSongForm');
            if(!form.checkValidity()) { form.reportValidity(); return; }

            const formData = new FormData(form);

            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').innerText = 'ƒêang t·∫£i l√™n Server & Cloud R2...';
            bootstrap.Modal.getInstance(document.getElementById('addSongModal')).hide();

            try {
                const result = await window.api(SONG_API_URL, {
                    method: 'POST',
                    body: formData
                });

                if (result && (result.status === 'success' || result.ok)) {
                    alert('Upload th√†nh c√¥ng!');
                    form.reset();

                    const newSong = result.data || result.song; 
                    
                    if (newSong && newSong.song_id) {
                        allSongsData.unshift(newSong);
                        
                        const tbody = document.getElementById('songTableBody');
                        if (tbody.querySelector('td[colspan]')) tbody.innerHTML = '';
                        
                        const newRowHtml = generateSongRow(newSong);
                        tbody.insertAdjacentHTML('afterbegin', newRowHtml);
                    } else {
                        await fetchSongs();
                    }

                } else {
                    alert('L·ªói Upload: ' + (result?.message || 'Kh√¥ng x√°c ƒë·ªãnh'));
                    new bootstrap.Modal(document.getElementById('addSongModal')).show();
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // ======================= X√ìA B√ÄI H√ÅT =======================
        window.deleteSong = async function(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i h√°t n√†y kh√¥ng?\nH√†nh ƒë·ªông n√†y c≈©ng s·∫Ω x√≥a file tr√™n Cloud.')) return;
            
            const btn = event.currentTarget;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;

            try {
                const res = await window.api(`${SONG_API_URL}/${id}`, { method: 'DELETE' });
                
                if (res && (res.status === 'success' || res.ok)) {
                    allSongsData = allSongsData.filter(s => s.song_id !== id);
                    
                    const row = document.getElementById(`song-row-${id}`);
                    if (row) {
                        row.style.transition = 'all 0.5s';
                        row.style.opacity = '0';
                        setTimeout(() => row.remove(), 500);
                    }
                } else {
                    alert('L·ªói x√≥a: ' + (res?.message || 'Unknown'));
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi!');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        // ======================= S·ª¨A B√ÄI H√ÅT =======================
        window.openEditModal = function(id, title, artist, genre) {
            document.getElementById('editSongId').value = id;
            document.getElementById('editTitle').value = title;
            document.getElementById('editArtist').value = artist;
            document.getElementById('editGenre').value = (genre === 'null' || genre === 'undefined') ? '' : genre;
            
            document.querySelectorAll('#editSongForm input[type="file"]').forEach(i => i.value = '');
            new bootstrap.Modal(document.getElementById('editSongModal')).show();
        }

        window.updateSong = async function() {
            const id = document.getElementById('editSongId').value;
            const form = document.getElementById('editSongForm');
            const formData = new FormData(form);

            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').innerText = 'ƒêang c·∫≠p nh·∫≠t d·ªØ li·ªáu...';
            bootstrap.Modal.getInstance(document.getElementById('editSongModal')).hide();

            try {
                const result = await window.api(`${SONG_API_URL}/${id}`, {
                    method: 'PUT',
                    body: formData
                });

                if (result && (result.status === 'success' || result.ok)) {
                    alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');

                    const updatedSong = result.data || result.song;

                    if (updatedSong && updatedSong.song_id) {
                        const index = allSongsData.findIndex(s => s.song_id == id);
                        if (index !== -1) {
                            allSongsData[index] = updatedSong;
                        }

                        const oldRow = document.getElementById(`song-row-${id}`);
                        if (oldRow) {
                            const temp = document.createElement('tbody');
                            temp.innerHTML = generateSongRow(updatedSong);
                            oldRow.replaceWith(temp.firstElementChild);
                        }
                    } else {
                        // Fallback
                        await fetchSongs();
                    }

                } else {
                    alert('L·ªói: ' + (result?.message || 'Unknown'));
                    new bootstrap.Modal(document.getElementById('editSongModal')).show();
                }
            } catch (error) {
                alert('L·ªói: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // --- KH·ªûI CH·∫†Y ---
        fetchSongs();
    }
</script>