<style>
    .cover-img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
    }

    .audio-preview {
        width: 150px;
        height: 30px;
    }

    #loadingOverlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
</style>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h5 class="mt-3">ƒêang x·ª≠ l√Ω file... Vui l√≤ng ƒë·ª£i!</h5>
</div>

<div class="container bg-white p-4 rounded shadow">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üéµ Kho Nh·∫°c Karaoke</h2>
        
        <div class="d-flex gap-2">
            <div class="input-group" style="width: 300px;">
                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                <input type="text" id="searchSong" class="form-control border-start-0" placeholder="T√¨m b√†i h√°t, ca sƒ©...">
            </div>

            <button class="btn btn-primary text-nowrap" data-bs-toggle="modal" data-bs-target="#addSongModal">
                <i class="bi bi-plus-lg"></i> Th√™m b√†i h√°t
            </button>
        </div>
    </div>

    <table class="table table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>Cover</th>
                <th>T√™n b√†i h√°t</th>
                <th>Ca sƒ©</th>
                <th>Th·ªÉ lo·∫°i</th>
                <th>Nghe th·ª≠ (Beat)</th>
                <th class="text-center">H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody id="songTableBody">
            </tbody>
    </table>
</div>

<div class="modal fade" id="addSongModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload B√†i H√°t M·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addSongForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">T√™n b√†i h√°t</label>
                            <input type="text" class="form-control" name="title" required placeholder="V√≠ d·ª•: Em c·ªßa ng√†y h√¥m qua">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ca sƒ©</label>
                            <input type="text" class="form-control" name="artist" required placeholder="V√≠ d·ª•: S∆°n T√πng M-TP">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Th·ªÉ lo·∫°i</label>
                        <input type="text" class="form-control" name="genre" placeholder="Nh·∫°c tr·∫ª, Remix...">
                    </div>

                    <div class="mb-3 p-3 border rounded bg-light">
                        <label class="form-label fw-bold">1. File Beat (Nh·∫°c n·ªÅn - MP3)</label>
                        <input type="file" class="form-control" name="beat" accept=".mp3, .m4a" required>
                    </div>
                    <div class="mb-3 p-3 border rounded bg-light">
                        <label class="form-label fw-bold">2. File Lyric (.lrc)</label>
                        <input type="file" class="form-control" name="lyric" accept=".lrc" required>
                    </div>
                    <div class="mb-3 p-3 border rounded bg-light">
                        <label class="form-label fw-bold">3. File Vocal (Gi·ªçng h√°t m·∫´u - Optional)</label>
                        <input type="file" class="form-control" name="vocal" accept=".mp3">
                        <small class="text-muted">D√πng cho t√≠nh nƒÉng ch·∫•m ƒëi·ªÉm AI.</small>
                    </div>
                    <div class="mb-3 p-3 border rounded bg-light">
                        <label class="form-label fw-bold">4. ·∫¢nh b√¨a</label>
                        <input type="file" class="form-control" name="image" accept="image/*" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" onclick="submitSong()">
                    <i class="bi bi-cloud-upload"></i> Upload Ngay
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editSongModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">S·ª≠a th√¥ng tin b√†i h√°t</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSongForm">
                    <input type="hidden" id="editSongId" name="id">
                    <div class="row mb-3">
                        <div class="col-md-4"><label class="form-label">T√™n b√†i h√°t</label><input type="text" class="form-control" id="editTitle" name="title" required></div>
                        <div class="col-md-4"><label class="form-label">Ca sƒ©</label><input type="text" class="form-control" id="editArtist" name="artist" required></div>
                        <div class="col-md-4"><label class="form-label">Th·ªÉ lo·∫°i</label><input type="text" class="form-control" id="editGenre" name="genre"></div>
                    </div>
                    <hr>
                    <p class="text-danger fst-italic mb-2">* Ch·ªâ ch·ªçn file n·∫øu b·∫°n mu·ªën thay ƒë·ªïi file c≈©</p>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">ƒê·ªïi Beat</label><input type="file" class="form-control" name="beat" accept=".mp3,.m4a"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">ƒê·ªïi Lyric</label><input type="file" class="form-control" name="lyric" accept=".lrc"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">ƒê·ªïi Vocal</label><input type="file" class="form-control" name="vocal" accept=".mp3"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">ƒê·ªïi ·∫¢nh</label><input type="file" class="form-control" name="image" accept="image/*"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="updateSong()">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>
</div>

<script>
    {
        const SONG_API_URL = '/api/admin/songs';
        let allSongsData = []; // Bi·∫øn ch·ª©a to√†n b·ªô b√†i h√°t ƒë·ªÉ l·ªçc offline

        // --- 1. H√ÄM V·∫º B·∫¢NG (RENDER) ---
        function renderSongTable() {
            const tbody = document.getElementById('songTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            // L·∫•y t·ª´ kh√≥a t√¨m ki·∫øm
            const term = document.getElementById('searchSong').value.toLowerCase().trim();

            // L·ªçc d·ªØ li·ªáu
            const filteredSongs = allSongsData.filter(song => {
                const title = (song.title || '').toLowerCase();
                const artist = (song.artist_name || '').toLowerCase();
                const genre = (song.genre || '').toLowerCase();
                return title.includes(term) || artist.includes(term) || genre.includes(term);
            });

            // N·∫øu kh√¥ng c√≥ k·∫øt qu·∫£
            if (filteredSongs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Kh√¥ng t√¨m th·∫•y b√†i h√°t n√†o ph√π h·ª£p.</td></tr>';
                return;
            }

            // V·∫Ω HTML
            filteredSongs.forEach(song => {
                tbody.innerHTML += `
                    <tr>
                        <td><img src="${song.image_url || 'https://via.placeholder.com/50'}" class="cover-img"></td>
                        <td class="fw-bold text-primary">${song.title}</td>
                        <td class="fw-bold">${song.artist_name}</td>
                        <td><span class="badge bg-secondary">${song.genre || 'N/A'}</span></td>
                        <td>
                            ${song.beat_url ? `<audio controls src="${song.beat_url}" class="audio-preview"></audio>` : '<span class="text-muted small">Ch∆∞a c√≥ beat</span>'}
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-warning me-1" onclick="openEditModal(${song.song_id}, '${song.title}', '${song.artist_name}', '${song.genre}')" title="S·ª≠a">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSong(${song.song_id})" title="X√≥a">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- 2. H√ÄM T·∫¢I D·ªÆ LI·ªÜU ---
        window.fetchSongs = async function() {
            const tbody = document.getElementById('songTableBody');
            if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary spinner-border-sm"></div> ƒêang t·∫£i...</td></tr>';

            try {
                const songs = await api(SONG_API_URL);
                if (!songs) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
                    return;
                }

                // L∆∞u d·ªØ li·ªáu v√†o bi·∫øn to√†n c·ª•c
                allSongsData = songs;
                
                // G·ªçi h√†m hi·ªÉn th·ªã
                renderSongTable();

            } catch (error) {
                console.error('L·ªói t·∫£i danh s√°ch:', error);
            }
        }

        // --- 3. G·∫ÆN S·ª∞ KI·ªÜN T√åM KI·∫æM ---
        const searchInput = document.getElementById('searchSong');
        if (searchInput) {
            searchInput.oninput = function() {
                renderSongTable(); // V·∫Ω l·∫°i b·∫£ng m·ªói khi g√µ ph√≠m
            };
        }

        // --- 4. C√ÅC H√ÄM X·ª¨ L√ù (ADD, EDIT, DELETE) ---
        window.submitSong = async function() {
            const form = document.getElementById('addSongForm');
            const formData = new FormData(form);

            document.getElementById('loadingOverlay').style.display = 'flex';
            const modalEl = document.getElementById('addSongModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            try {
                const result = await api(SONG_API_URL, {
                    method: 'POST',
                    body: formData
                });

                if (result && result.status === 'success') {
                    alert('Upload th√†nh c√¥ng!');
                    form.reset();
                    fetchSongs(); // T·∫£i l·∫°i d·ªØ li·ªáu m·ªõi
                } else {
                    alert('L·ªói: ' + (result ? result.message : 'Unknown'));
                }
            } catch (error) {
                alert('L·ªói: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        window.deleteSong = async function(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i n√†y kh√¥ng?')) return;
            try {
                const res = await api(`${SONG_API_URL}/${id}`, { method: 'DELETE' });
                if (res && res.status === 'success') {
                    fetchSongs();
                } else {
                    alert('L·ªói x√≥a: ' + (res ? res.message : 'Unknown'));
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi!');
            }
        }

        window.openEditModal = function(id, title, artist, genre) {
            document.getElementById('editSongId').value = id;
            document.getElementById('editTitle').value = title;
            document.getElementById('editArtist').value = artist;
            document.getElementById('editGenre').value = (genre === 'null' || genre === 'undefined') ? '' : genre;
            // Reset c√°c √¥ ch·ªçn file
            document.querySelectorAll('#editSongForm input[type="file"]').forEach(i => i.value = '');
            new bootstrap.Modal(document.getElementById('editSongModal')).show();
        }

        window.updateSong = async function() {
            const id = document.getElementById('editSongId').value;
            const form = document.getElementById('editSongForm');
            const formData = new FormData(form);

            document.getElementById('loadingOverlay').style.display = 'flex';
            bootstrap.Modal.getInstance(document.getElementById('editSongModal')).hide();

            try {
                const result = await api(`${SONG_API_URL}/${id}`, {
                    method: 'PUT',
                    body: formData
                });

                if (result && result.status === 'success') {
                    alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                    fetchSongs();
                } else {
                    alert('L·ªói: ' + (result ? result.message : 'Unknown'));
                }
            } catch (error) {
                alert('L·ªói: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // Kh·ªüi ch·∫°y l·∫ßn ƒë·∫ßu
        fetchSongs();
    }
</script>